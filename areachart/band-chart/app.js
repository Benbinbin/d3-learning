// å‚è€ƒè‡ª https://observablehq.com/@d3/band-chart/2

/**
 *
 * æ„å»º svg
 *
 */
const container = document.getElementById("container"); // å›¾åƒçš„å®¹å™¨

// è·å–å°ºå¯¸å¤§å°
const width = container.clientWidth; // å®½åº¦
const height = container.clientHeight; // é«˜åº¦
// margin ä¸ºå‰ç¼€çš„å‚æ•°
// å…¶ä½œç”¨æ˜¯åœ¨ svg çš„å¤–å‘¨ç•™ç™½ï¼Œæ„å»ºä¸€ä¸ªæ˜¾ç¤ºçš„å®‰å…¨åŒºï¼Œä»¥ä¾¿åœ¨å››å‘¨æ˜¾ç¤ºåæ ‡è½´
const marginTop = 20;
const marginRight = 30;
const marginBottom = 30;
const marginLeft = 40;

// åˆ›å»º svg
// åœ¨å®¹å™¨ <div id="container"> å…ƒç´ å†…åˆ›å»ºä¸€ä¸ª SVG å…ƒç´ 
// è¿”å›ä¸€ä¸ªé€‰æ‹©é›†ï¼Œåªæœ‰ svg ä¸€ä¸ªå…ƒç´ 
const svg = d3
  .select("#container")
  .append("svg")
  .attr("width", width)
  .attr("height", height)
  .attr("viewBox", [0, 0, width, height]);

/**
 *
 * å¼‚æ­¥è·å–æ•°æ®
 * å†åœ¨å›è°ƒå‡½æ•°ä¸­æ‰§è¡Œç»˜åˆ¶æ“ä½œ
 *
 */
// æ•°æ®æ¥æºç½‘é¡µ https://observablehq.com/@d3/band-chart/2 çš„æ–‡ä»¶é™„ä»¶
const dataURL =
  "https://gist.githubusercontent.com/Benbinbin/814a812d5caf8ff7764469b9d992cdf0/raw/1adacfb1566d014f040db08b8cc66d764fb7f8ae/temp.csv";

d3.csv(dataURL, d3.autoType).then((sftemp) => {
  // éœ€è¦æ£€æŸ¥ä¸€ä¸‹æ•°æ®è§£æçš„ç»“æœï¼Œå¯èƒ½å¹¶ä¸æ­£ç¡®ï¼Œéœ€è¦åœ¨åé¢çš„æ­¥éª¤é‡Œå†è¿›è¡Œç›¸åº”çš„å¤„ç†
  console.log(sftemp);

  /**
   *
   * æ„å»ºæ¯”ä¾‹å°º
   *
   */
  // è®¾ç½®æ¨ªåæ ‡è½´çš„æ¯”ä¾‹å°º
  // æ¨ªåæ ‡è½´çš„æ•°æ®æ˜¯æ—¥æœŸï¼ˆæ—¶é—´ï¼‰ï¼Œä½¿ç”¨ d3.scaleUtc æ„å»ºä¸€ä¸ªæ—¶é—´æ¯”ä¾‹å°ºï¼ˆè¿ç»­å‹æ¯”ä¾‹å°ºçš„ä¸€ç§ï¼‰
  // è¯¥æ—¶é—´æ¯”ä¾‹å°ºé‡‡ç”¨åè°ƒä¸–ç•Œæ—¶ UTCï¼Œå¤„äºä¸åŒæ—¶åŒºçš„ç”¨æˆ·ä¹Ÿä¼šæ˜¾ç¤ºåŒæ ·çš„æ—¶é—´
  // å…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-scale/time
  // æˆ–è¿™ä¸€ç¯‡ç¬”è®° https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-scale#æ—¶é—´æ¯”ä¾‹å°º-time-scales
  const x = d3.scaleUtc()
    // è®¾ç½®å®šä¹‰åŸŸèŒƒå›´
    // ä»æ•°æ®é›†çš„æ¯ä¸ªæ•°æ®ç‚¹ä¸­æå–å‡ºæ—¥æœŸï¼ˆæ—¶é—´ï¼‰ï¼Œå¹¶ç”¨ d3.extent() è®¡ç®—å‡ºå®ƒçš„èŒƒå›´
    .domain(d3.extent(sftemp, d => d.date))
    // è®¾ç½®å€¼åŸŸèŒƒå›´ï¼ˆæ‰€æ˜ å°„çš„å¯è§†å…ƒç´ ï¼‰
    // svg å…ƒç´ çš„å®½åº¦ï¼ˆå‡å»ç•™ç™½åŒºåŸŸï¼‰
    .range([marginLeft, width - marginRight]);

  // è®¾ç½®çºµåæ ‡è½´çš„æ¯”ä¾‹å°º
  // çºµåæ ‡è½´çš„æ•°æ®æ˜¯è¿ç»­å‹çš„æ•°å€¼ï¼ˆæ¸©åº¦ï¼‰ï¼Œä½¿ç”¨ d3.scaleLinear æ„å»ºä¸€ä¸ªçº¿æ€§æ¯”ä¾‹å°º
  const y = d3.scaleLinear()
    // è®¾ç½®å®šä¹‰åŸŸèŒƒå›´
    // [ymin, ymax] å…¶ä¸­ ymin æ˜¯æ¯æ—¥æœ€ä½æ°”æ¸©çš„æœ€å°å€¼ï¼Œ ymax æ˜¯æ¯æ—¥æœ€é«˜æ°”æ¸©çš„æœ€å¤§å€¼
    // å¦å¤–è¿˜ä½¿ç”¨ continuous.nice(count) æ–¹æ³•ç¼–è¾‘å®šä¹‰åŸŸçš„èŒƒå›´ï¼Œé€šè¿‡å››èˆäº”å…¥ä½¿å…¶ä¸¤ç«¯çš„å€¼æ›´ã€Œæ•´é½ã€nice
    // å‚æ•° count ä¸€ä¸ªæ•°å­—ï¼Œç”¨äºè®¾ç½®è¯¥æ¯”ä¾‹å°ºæ‰€å¯¹åº”çš„åæ ‡è½´çš„åˆ»åº¦çº¿æ•°é‡ï¼ˆD3 ä¼šä»¥æ­¤ä½œä¸ºä¸€ä¸ªå‚è€ƒå€¼ï¼Œæœ€ç»ˆç”Ÿæˆçš„åˆ»åº¦çº¿æ•°é‡å¯èƒ½ä¸ count ä¸åŒï¼Œä»¥ä¾¿åˆ»åº¦åˆ’åˆ†æ›´åˆç†ï¼‰ï¼Œä»è€Œå½±å“äº†å®šä¹‰åŸŸçš„è°ƒæ•´æ–¹å¼
    // å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-scale/linear#linear_nice
    .domain([d3.min(sftemp, d => d.low), d3.max(sftemp, d => d.high)]).nice(10)
    // è®¾ç½®å€¼åŸŸèŒƒå›´
    // svg å…ƒç´ çš„é«˜åº¦ï¼ˆå‡å»ç•™ç™½åŒºåŸŸï¼‰
    .range([height - marginBottom, marginTop]);

  /**
   *
   * ç»˜åˆ¶åæ ‡è½´
   *
   */
  // ç»˜åˆ¶æ¨ªåæ ‡è½´
  svg.append("g")
    // é€šè¿‡è®¾ç½® CSS çš„ transform å±æ€§å°†æ¨ªåæ ‡è½´å®¹å™¨ã€Œç§»åŠ¨ã€åˆ°åº•éƒ¨
    .attr("transform", `translate(0,${height - marginBottom})`)
    // æ¨ªè½´æ˜¯ä¸€ä¸ªåˆ»åº¦å€¼æœä¸‹çš„åæ ‡è½´
    // é€šè¿‡ axis.ticks(count) è®¾ç½®åˆ»åº¦æ•°é‡çš„å‚è€ƒå€¼ï¼ˆé¿å…åˆ»åº¦è¿‡å¤šå¯¼è‡´åˆ»åº¦å€¼é‡å è€Œå½±å“å›¾è¡¨çš„å¯è¯»æ€§ï¼‰
    // è€Œä¸”å°†åæ ‡è½´çš„å¤–ä¾§åˆ»åº¦ tickSizeOuter é•¿åº¦è®¾ç½®ä¸º 0ï¼ˆå³å–æ¶ˆåæ ‡è½´é¦–å°¾ä¸¤ç«¯çš„åˆ»åº¦ï¼‰
    .call(d3.axisBottom(x).ticks(width / 80).tickSizeOuter(0))
    // ğŸ’¡ åˆ æ‰ä¸Šä¸€æ­¥æ‰€ç”Ÿæˆçš„åæ ‡è½´çš„è½´çº¿ï¼ˆå®ƒå«æœ‰ domain ç±»åï¼‰
    // ğŸ‘‡ åœ¨åé¢ä½¿ç”¨çºµåæ ‡è½´çš„åˆ»åº¦çº¿æ¥ç»˜åˆ¶
    .call(g => g.select(".domain").remove());
  // ğŸ’¡ æ³¨æ„ä»¥ä¸Šä½¿ç”¨çš„æ˜¯æ–¹æ³• selection.call(axis) çš„æ–¹å¼æ¥è°ƒç”¨åæ ‡è½´å¯¹è±¡ï¼ˆæ–¹æ³•ï¼‰
  // ä¼šå°†é€‰æ‹©é›†ä¸­çš„å…ƒç´  <g> ä¼ é€’ç»™åæ ‡è½´å¯¹è±¡çš„æ–¹æ³•ï¼Œä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°
  // ä»¥ä¾¿å°†åæ ‡è½´åœ¨ç›¸åº”å®¹å™¨å†…éƒ¨æ¸²æŸ“å‡ºæ¥
  // å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-selection/control-flow#selection_call
  // æˆ–è¿™ä¸€ç¯‡æ–‡æ¡£ https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-data-binding#å…¶ä»–æ–¹æ³•

  // ç»˜åˆ¶çºµåæ ‡è½´
  svg.append("g")
    // é€šè¿‡è®¾ç½® CSS çš„ transform å±æ€§å°†çºµå‘åæ ‡è½´å®¹å™¨ã€Œç§»åŠ¨ã€åˆ°å·¦ä¾§
    .attr("transform", `translate(${marginLeft},0)`)
    // çºµè½´æ˜¯ä¸€ä¸ªåˆ»åº¦å€¼æœå·¦çš„åæ ‡è½´
    .call(d3.axisLeft(y))
    // åˆ æ‰ä¸Šä¸€æ­¥æ‰€ç”Ÿæˆçš„åæ ‡è½´çš„è½´çº¿ï¼ˆå®ƒå«æœ‰ domain ç±»åï¼‰
    .call(g => g.select(".domain").remove())
    // å¤åˆ¶äº†ä¸€ä»½åˆ»åº¦çº¿ï¼Œç”¨ä»¥ç»˜åˆ¶å›¾ä¸­æ¨ªå‘çš„ç½‘æ ¼å‚è€ƒçº¿
    .call(g => g.selectAll(".tick line").clone()
      // è°ƒæ•´å¤åˆ¶åçš„åˆ»åº¦çº¿çš„ç»ˆç‚¹ä½ç½®ï¼ˆå¾€å³ç§»åŠ¨ï¼‰
      .attr("x2", width - marginLeft - marginRight)
      .attr("stroke-opacity", 0.1)) // è°ƒå°å‚è€ƒçº¿çš„é€æ˜åº¦
    // ä¸ºåæ ‡è½´æ·»åŠ é¢å¤–ä¿¡æ¯åç§°ï¼ˆä¸€èˆ¬æ˜¯åˆ»åº¦å€¼çš„å•ä½ç­‰ä¿¡æ¯ï¼‰
    .call(g => g.append("text")
      // å°†è¯¥æ–‡æœ¬ç§»åŠ¨åˆ°åæ ‡è½´çš„é¡¶éƒ¨ï¼ˆå³å®¹å™¨çš„å·¦ä¸Šè§’ï¼‰
      .attr("x", -marginLeft)
      .attr("y", 10)
      .attr("fill", "currentColor") // è®¾ç½®æ–‡æœ¬çš„é¢œè‰²
      .attr("text-anchor", "start") // è®¾ç½®æ–‡æœ¬çš„å¯¹é½æ–¹å¼
      .text("â†‘ Temperature (Â°F)")); // è®¾ç½®æ–‡æœ¬å†…å®¹

  /**
   *
   * ç»˜åˆ¶é¢ç§¯å›¾å†…çš„é¢ç§¯å½¢çŠ¶
   *
   */
  // ä½¿ç”¨ d3.area() åˆ›å»ºä¸€ä¸ªé¢ç§¯ç”Ÿæˆå™¨
  // é¢ç§¯ç”Ÿæˆå™¨ä¼šåŸºäºç»™å®šçš„æ•°æ®ç”Ÿæˆé¢ç§¯å½¢çŠ¶
  // è°ƒç”¨é¢ç§¯ç”Ÿæˆå™¨æ—¶è¿”å›çš„ç»“æœï¼Œä¼šåŸºäºç”Ÿæˆå™¨æ˜¯å¦è®¾ç½®äº†ç”»å¸ƒä¸Šä¸‹æ–‡ context è€Œä¸åŒã€‚å¦‚æœè®¾ç½®äº†ç”»å¸ƒä¸Šä¸‹æ–‡ contextï¼Œåˆ™ç”Ÿæˆä¸€ç³»åˆ—åœ¨ç”»å¸ƒä¸Šç»˜åˆ¶è·¯å¾„çš„æ–¹æ³•ï¼Œé€šè¿‡è°ƒç”¨å®ƒä»¬å¯ä»¥å°†è·¯å¾„ç»˜åˆ¶åˆ°ç”»å¸ƒä¸Šï¼›å¦‚æœæ²¡æœ‰è®¾ç½®ç”»å¸ƒä¸Šä¸‹æ–‡ contextï¼Œåˆ™ç”Ÿæˆå­—ç¬¦ä¸²ï¼Œå¯ä»¥ä½œä¸º `<path>` å…ƒç´ çš„å±æ€§ `d` çš„å€¼
  // å…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-shape/area
  // æˆ–è¿™ä¸€ç¯‡ç¬”è®° https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-shape#é¢ç§¯ç”Ÿæˆå™¨-areas
  const area = d3.area()
    // è®¾ç½®ä¸¤ç‚¹ä¹‹é—´çš„æ›²çº¿æ’å€¼å™¨ï¼Œè¿™é‡Œä½¿ç”¨ D3 æ‰€æä¾›çš„ä¸€ç§å†…ç½®æ›²çº¿æ’å€¼å™¨ d3.curveStep
    // è¯¥æ’å€¼æ•ˆæœæ˜¯åœ¨ä¸¤ä¸ªæ•°æ®ç‚¹ä¹‹é—´ï¼Œç”Ÿæˆé˜¶æ¢¯å½¢çŠ¶çš„çº¿æ®µï¼ˆä½œä¸ºé¢ç§¯å›¾çš„è¾¹ç•Œï¼‰
    // å…·ä½“æ•ˆæœå‚è€ƒ https://d3js.org/d3-shape/curve#curveStep
    .curve(d3.curveStep)
    // è®¾ç½®ä¸‹è¾¹ç•Œçº¿æ¨ªåæ ‡è¯»å–å‡½æ•°
    // è¯¥å‡½æ•°ä¼šåœ¨è°ƒç”¨é¢ç§¯ç”Ÿæˆå™¨æ—¶ï¼Œä¸ºæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œä»¥è¿”å›è¯¥æ•°æ®æ‰€å¯¹åº”çš„æ¨ªåæ ‡
    // è¿™é‡ŒåŸºäºæ¯ä¸ªæ•°æ®ç‚¹çš„æ—¥æœŸï¼ˆæ—¶é—´ï¼‰d.date å¹¶é‡‡ç”¨æ¯”ä¾‹å°º x è¿›è¡Œæ˜ å°„ï¼Œè®¡ç®—å‡ºç›¸åº”çš„æ¨ªåæ ‡
    .x(d => x(d.date))
    // è®¾ç½®ä¸‹è¾¹ç•Œçº¿çš„çºµåæ ‡çš„è¯»å–å‡½æ•°
    // è¿™é‡Œçš„é¢ç§¯å›¾çš„ä¸‹è¾¹ç•Œçº¿æ˜¯æ¯ä¸ªæ•°æ®ç‚¹çš„æœ€ä½æ°”æ¸© d.lowï¼Œå¹¶é‡‡ç”¨æ¯”ä¾‹å°º y è¿›è¡Œæ˜ å°„ï¼Œå¾—åˆ°çºµåæ ‡è½´åœ¨ svg ä¸­çš„åæ ‡ä½ç½®
    .y0(d => y(d.low))
    // è®¾ç½®ä¸Šè¾¹ç•Œçº¿çš„çºµåæ ‡çš„è¯»å–å‡½æ•°
    // è¿™é‡Œçš„é¢ç§¯å›¾çš„ä¸‹è¾¹ç•Œçº¿æ˜¯æ¯ä¸ªæ•°æ®ç‚¹çš„æœ€é«˜æ°”æ¸© d.highï¼Œå¹¶é‡‡ç”¨æ¯”ä¾‹å°º y è¿›è¡Œæ˜ å°„ï¼Œå¾—åˆ°çºµåæ ‡è½´åœ¨ svg ä¸­çš„åæ ‡ä½ç½®
    .y1(d => y(d.high));

  // å°†é¢ç§¯å½¢çŠ¶ç»˜åˆ¶åˆ°é¡µé¢ä¸Š
  svg.append("path") // ä½¿ç”¨è·¯å¾„ <path> å…ƒç´ ç»˜åˆ¶é¢ç§¯å½¢çŠ¶
    .datum(sftemp) // ç»‘å®šæ•°æ®
    // å°†é¢ç§¯çš„å¡«å……é¢œè‰²è®¾ç½®ä¸ºè“è‰²
    .attr("fill", "steelblue")
    // ç”±äºé¢ç§¯ç”Ÿæˆå™¨å¹¶æ²¡æœ‰è°ƒç”¨æ–¹æ³• area.context(parentDOM) è®¾ç½®ç”»å¸ƒä¸Šä¸‹æ–‡
    // æ‰€ä»¥è°ƒç”¨é¢ç§¯ç”Ÿæˆå™¨ area è¿”å›çš„ç»“æœæ˜¯å­—ç¬¦ä¸²
    // è¯¥å€¼ä½œä¸º `<path>` å…ƒç´ çš„å±æ€§ `d` çš„å€¼
    .attr("d", area);
});
