// å‚è€ƒè‡ª https://observablehq.com/@d3/diverging-bar-chart
// è¿™æ˜¯å‚ç›´æ–¹å‘çš„æ¡å½¢å›¾ https://observablehq.com/@d3/bar-chart çš„ã€Œå‘æ•£å‹ã€ç‰ˆæœ¬
/**
 *
 * å°†æ„å»ºæ¡å½¢å›¾çš„æ ¸å¿ƒä»£ç å°è£…ä¸ºä¸€ä¸ªå‡½æ•°ï¼ˆæ–¹ä¾¿å¤ç”¨ï¼‰
 *
 */
// Copyright 2021 Observable, Inc.
// Released under the ISC license.
// https://observablehq.com/@d3/diverging-bar-chart
function DivergingBarChart(
  data,
  svg,
  {
    // æ¯ä¸ªæ•°æ®ç‚¹çš„ x å€¼çš„ accessor function è®¿é—®å‡½æ•°
    // ä»æ•°æ®ç‚¹çš„åŸå§‹å€¼ä¸­æå–å‡ºç”¨ä½œæ¨ªåæ ‡å€¼ï¼ˆæ¨ªåæ ‡å€¼åº”è¯¥é‡‡ç”¨ quantitative æ•°å€¼å‹æ•°æ®ï¼Œä»¥è¡¨ç¤ºå…·ä½“å®šé‡çš„å€¼ï¼‰
    x = (d) => d, // given d in data, returns the (quantitative) x-value
    // æ¯ä¸ªæ•°æ®ç‚¹çš„ y å€¼çš„ accessor function è®¿é—®å‡½æ•°
    // ä»æ•°æ®ç‚¹çš„åŸå§‹å€¼ä¸­æå–å‡ºç”¨ä½œçºµåæ ‡å€¼ï¼ˆçºµåæ ‡å€¼åº”è¯¥é‡‡ç”¨ ordinal ç¦»æ•£å‹æ•°æ®ï¼Œä»¥è¡¨ç¤ºä¸åŒç±»åˆ«ï¼‰
    y = (d, i) => i, // given d in data, returns the (ordinal) y-value
    // æ¯ä¸ªæ•°æ®ç‚¹çš„æç¤ºä¿¡æ¯çš„ accessor function è®¿é—®å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„å…¥å‚æ˜¯å„ä¸ªæ•°æ®ç‚¹ d
    title,
    // ä»¥ä¸‹æœ‰ä¸€äº›å…³äºå›¾å½¢çš„å®½é«˜ã€è¾¹è·å°ºå¯¸ç›¸å…³çš„å‚æ•°
    // margin ä¸ºå‰ç¼€çš„äº§ç”Ÿæ˜¯åœ¨å¤–å››è¾¹ç•™ç™½ï¼Œæ„å»ºä¸€ä¸ªæ˜¾ç¤ºçš„å®‰å…¨åŒºï¼Œä»¥ä¾¿åœ¨å››å‘¨æ˜¾ç¤ºåæ ‡è½´
    marginTop = 30, // top margin, in pixels
    marginRight = 40, // right margin, in pixels
    marginBottom = 10, // bottom margin, in pixels
    marginLeft = 40, // left margin, in pixels
    width = 640, // svg çš„å®½åº¦
    height, // svg çš„é«˜åº¦
    xType = d3.scaleLinear, // æ¨ªè½´æ‰€é‡‡ç”¨çš„æ¯”ä¾‹å°ºï¼Œå¯¹äºæ•°å€¼å‹æ•°æ®ï¼Œé»˜è®¤é‡‡ç”¨çº¿æ€§æ¯”ä¾‹å°º
    xDomain, // æ¨ªåæ ‡è½´çš„å®šä¹‰åŸŸèŒƒå›´ï¼Œå³æ•°æ®çš„èŒƒå›´ [xmin, xmax]
    // æ¨ªåæ ‡è½´çš„å€¼åŸŸï¼ˆå¯è§†åŒ–å±æ€§ï¼Œè¿™é‡Œæ˜¯é•¿åº¦ï¼‰èŒƒå›´ [left, right] ä»å·¦è‡³å³ï¼Œå’Œæˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨ä¸€è‡´
    xRange = [marginLeft, width - marginRight],
    xFormat, // æ ¼å¼åŒ–æ•°å­—çš„è¯´æ˜ç¬¦ specifier ç”¨äºæ ¼å¼åŒ–æ¨ªåæ ‡è½´çš„åˆ»åº¦å€¼
    xLabel, // ä¸ºæ¨ªåæ ‡è½´æ·»åŠ é¢å¤–æ–‡æœ¬ï¼ˆä¸€èˆ¬æ˜¯åˆ»åº¦å€¼çš„å•ä½ç­‰ä¿¡æ¯ï¼‰
    // çºµåæ ‡è½´çš„å®šä¹‰åŸŸèŒƒå›´ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªä¸åŒçš„ç±»åˆ«
    // ä¸€èˆ¬æ˜¯åŸºäºåŸå§‹æ•°æ®ï¼ˆå»é‡ï¼‰æå–è€Œæˆçš„
    // ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œæ‰‹åŠ¨ç›´æ¥è®¾ç½®å¸Œæœ›æ˜¾ç¤ºçš„ç±»åˆ«ï¼Œç„¶ååœ¨å‡½æ•°å†…éƒ¨æœ‰ç›¸å…³çš„ä»£ç å¯¹æ•°æ®è¿›è¡Œç­›é€‰
    yDomain, // an array of (ordinal) y-values
    // çºµåæ ‡è½´çš„å€¼åŸŸ
    // å¦‚æœçºµåæ ‡æ˜¯æ˜ å°„å®šé‡æ•°å€¼æ—¶ï¼Œåº”è¯¥ç‰¹åˆ«ç•™æ„ svg çš„åæ ‡ä½“ç³»çš„æ­£æ–¹å‘ï¼ˆå‘å³ï¼Œå‘ä¸‹ï¼‰
    // ä½†æ˜¯å› ä¸ºå½“å‰ç»˜åˆ¶çš„æ˜¯æ¨ªå‘æ¡å½¢å›¾ï¼Œçºµè½´æ˜ å°„çš„æ˜¯åˆ†ç±»æ•°æ®
    // ğŸ’¡ æ‰€ä»¥è¿™é‡Œçš„å€¼åŸŸ**ä¸ä¸€å®šéœ€è¦**é‡‡ç”¨ä»ä¸‹å¾€ä¸Šä¸å®šä¹‰åŸŸè¿›è¡Œæ˜ å°„ [bottom, top]
    // è¿™é‡Œé»˜è®¤å°±é‡‡ç”¨ [top, bottom]
    yRange, // [top, bottom]
    yPadding = 0.1, // è®¾ç½®æ¡å½¢å›¾ä¸­é‚»è¿‘æŸ±å­ä¹‹é—´çš„é—´éš”å¤§å°
    // å°†æ­£è´Ÿå€¼æ•°æ®æ˜ å°„ä¸ºä¸åŒçš„é¢œè‰²
    // d3.schemePiYG[3] æ˜¯ä¸€ä¸ª Color Scheme
    // d3.schemePiYG æ˜¯ä¸€ä¸ªç¦»æ•£å‹çš„é…è‰²æ–¹æ¡ˆï¼Œä»ä¸€ä¸ªè‰²è°±é‡Œè¿›è¡Œé‡‡æ ·ï¼Œæ„æˆä¸€ç³»åˆ—æœ‰æ˜æ˜¾å¯¹æ¯”åº¦çš„è‰²å€¼
    // å®ƒæ˜¯ä¸€ä¸ªåŒ…å« 12 ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œé™¤äº†å‰ 3 ä¸ªå…ƒç´ ï¼ˆå‰ 3 ä¸ªå…ƒç´ ä¸ºç©ºï¼Œå› ä¸ºé‡‡æ ·è¾ƒå°‘ï¼Œæ— æ³•ä¿è¯é¢œè‰²æœ‰è¶³å¤Ÿçš„å¯¹æ¯”åº¦ï¼Œå®ç”¨æ€§è¾ƒä½ï¼Ÿï¼‰å…¶ä»–å…ƒç´ éƒ½æ˜¯åµŒå¥—æ•°ç»„ï¼ˆé‡Œé¢çš„å…ƒç´ éƒ½æ˜¯è¡¨ç¤ºé¢œè‰²å€¼çš„å­—ç¬¦ä¸²ï¼‰
    // å…·ä½“å¯ä»¥æŸ¥çœ‹æœ€åçš„ä¸€ç³»åˆ— cell
    // å¯ä»¥ä½¿ç”¨ d3.schemePiYG[k] æ¥è·å–ä¸€ç§é…è‰²æ–¹æ¡ˆï¼Œk çš„å–å€¼èŒƒå›´æ˜¯ 3 è‡³ 11
    // é»˜è®¤é‡‡ç”¨ d3.schemePiYG[3] ä½œä¸ºé…è‰²æ–¹æ¡ˆï¼Œå®ƒè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­åŒ…å« 3 ä¸ªå…ƒç´ ï¼ˆä½†åœ¨è¯¥å®ä¾‹ä¸­ï¼Œåªéœ€è¦ä¸¤ä¸ªè‰²å€¼ï¼Œæ‰€ä»¥å–æ•°ç»„çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå…ƒç´ ï¼Œå®ƒä»¬çš„å¯¹æ¯”åº¦æœ€æ˜æ˜¾ï¼Œä¾¿äºåŒºåˆ†ä¸¤ç§ä¸åŒçš„ç±»åˆ«ï¼‰ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªè‰²å€¼
    // å‚è€ƒ https://github.com/d3/d3-scale-chromatic/blob/v3.0.0/README.md#diverging
    colors = d3.schemePiYG[3] // [negative, â€¦, positive] colors
  } = {}
) {
  /**
   *
   * å¤„ç†æ•°æ®
   *
   */
  // é€šè¿‡ d3.map() è¿­ä»£å‡½æ•°ï¼Œä½¿ç”¨ç›¸åº”çš„ accessor function è®¿é—®å‡½æ•°ä»åŸå§‹æ•°æ® data ä¸­è·å–ç›¸åº”çš„å€¼
  const X = d3.map(data, x);
  const Y = d3.map(data, y);

  /**
   *
   * æ„å»ºæ¯”ä¾‹å°ºå’Œåæ ‡è½´
   *
   */
  // è®¡ç®—åæ ‡è½´çš„å®šä¹‰åŸŸèŒƒå›´
  // ä½¿ç”¨æ–¹æ³• d3.extent è¿”å›ä¸€ä¸ªç”±æ‰€æœ‰æ•°æ®çš„ x å€¼ä¸­çš„æœ€å°å€¼å’Œæœ€å¤§å€¼æ„æˆçš„æ•°ç»„ [xmin, xmax]
  if (xDomain === undefined) xDomain = d3.extent(X);

  // å¦‚æœè°ƒç”¨å‡½æ•°æ—¶æ²¡æœ‰ä¼ å…¥çºµåæ ‡è½´çš„å®šä¹‰åŸŸèŒƒå›´ yDomainï¼Œåˆ™å°†å…¶å…ˆè®¾ç½®ä¸ºç”±æ‰€æœ‰æ•°æ®ç‚¹çš„ y å€¼æ„æˆçš„æ•°ç»„
  if (yDomain === undefined) yDomain = Y;
  // ç„¶ååŸºäº yDomain å€¼åˆ›å»ºä¸€ä¸ª InternSet å¯¹è±¡ï¼Œä»¥ä¾¿å»é‡
  // è¿™æ ·æ‰€å¾—çš„ yDomain é‡Œçš„å…ƒç´ éƒ½æ˜¯å”¯ä¸€çš„ï¼Œä½œä¸ºçºµåæ ‡è½´çš„å®šä¹‰åŸŸï¼ˆåˆ†ç±»çš„ä¾æ®ï¼‰
  yDomain = new d3.InternSet(yDomain);

  // è¿™é‡Œè¿˜åšäº†ä¸€æ­¥æ•°æ®æ¸…æ´—
  // åŸºäºçºµåæ ‡è½´çš„å®šä¹‰åŸŸæ‰€åŒ…å«çš„ç±»åˆ«
  // ä½¿ç”¨ JavaScript æ•°ç»„çš„åŸç”Ÿæ–¹æ³• arr.filter() ç­›æ‰ä¸å±äº yDomain ç±»åˆ«çš„ä»»æ„ä¸€ä¸ªçš„æ•°æ®ç‚¹
  // å…¶ä¸­ d3.range(X.length) ç”Ÿæˆä¸€ä¸ªç­‰å·®æ•°åˆ—ï¼ˆä½¿ç”¨ Y.length ä¹Ÿå¯ä»¥ï¼‰ï¼Œä½œä¸ºç´¢å¼•å€¼ï¼Œä¾¿äºå¯¹æ•°æ®ç‚¹è¿›è¡Œè¿­ä»£
  // Lookup the x-value for a given y-value.
  const I = d3.range(X.length).filter((i) => yDomain.has(Y[i]));

  // è¿™é‡Œæ„å»ºä¸€ä¸ª InternMap å¯¹è±¡ï¼ˆå¯ä»¥å°†å®ƒç†è§£ä¸ºä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œä½†æ˜¯æœ‰ä¸€äº› D3.js æ·»åŠ çš„é¢å¤–å±æ€§ï¼‰
  // è¯¥å¯¹è±¡ç”±ä¸€ç³»åˆ—çš„é”®å€¼å¯¹æ„æˆï¼Œå…¶ä¸­é”®æ˜¯ç±»åˆ«ï¼ˆå³åœ°åï¼‰ï¼Œå€¼åˆ™æ˜¯å¯¹åº”çš„äººå£ï¼ˆ2019 å¹´- 2010 å¹´ï¼‰å·®å€¼
  // æœ€åè¿”å›çš„ InternMap å¯¹è±¡å¯ä»¥æŸ¥çœ‹ ğŸ‘‡ ä¸‹ä¸€ä¸ª cell æ‰€æ¼”ç¤ºçš„ç»“æœ
  // ä¹‹ååœ¨ç»˜åˆ¶ Y è½´æ—¶ï¼Œä¼šæ ¹æ®å·®å€¼çš„æ­£è´Ÿå€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ä¿®æ”¹ç›¸åº”çš„åæ ‡è½´çš„åˆ»åº¦å€¼çš„ä½ç½®ï¼ˆé»˜è®¤åœ¨å·¦ä¾§ï¼Œå› ä¸ºè´Ÿå€¼çš„æŸ±å­å‘å·¦ä¾§ç»˜åˆ¶çš„ï¼Œæ‰€ä»¥éœ€è¦æŠŠåˆ»åº¦å€¼ç§»åˆ° Y è½´çš„å³ä¾§ï¼‰
  const YX = d3.rollup(
    I,
    ([i]) => X[i],
    (i) => Y[i]
  );
  // æ–¹æ³• d3.rollup(iterable, reduce, ...keys) åŸºäºæŒ‡å®šçš„å±æ€§ keys è¿›è¡Œåˆ†ç»„ï¼Œå¹¶å¯¹å„åˆ†ç»„è¿›è¡Œ reduceã€Œå‹ç¼©é™ç»´ã€ï¼Œæœ€åè¿”å›ä¸€ä¸ª InternMap å¯¹è±¡
  // * ç¬¬ä¸€ä¸ªå‚æ•° iterable æ˜¯å¯è¿­ä»£å¯¹è±¡ï¼Œå³æ•°æ®é›†
  // * ç¬¬äºŒä¸ªå‚æ•° reduce æ˜¯å¯¹åˆ†ç»„è¿›è¡Œå‹ç¼©çš„å‡½æ•°ï¼Œæ¯ä¸ªåˆ†ç»„ä¼šä¾æ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼ˆå…¥å‚å°±æ˜¯åŒ…å«å„ä¸ªåˆ†ç»„å…ƒç´ çš„æ•°ç»„ï¼‰ï¼Œè¿”å›å€¼ä¼šä½œä¸º InternMap å¯¹è±¡ä¸­ï¼ˆå„åˆ†ç»„çš„ï¼‰é”®å€¼å¯¹ä¸­çš„å€¼
  // * ä½™ä¸‹çš„å‚æ•° ...keys æ˜¯ä¸€ç³»åˆ—è¿”å›åˆ†ç»„ä¾æ®
  // è¯¥å®ä¾‹æ˜¯æ ¹æ®åœ°å Y[i] è¿›è¡Œåˆ†ç»„
  // ç„¶åå†å¯¹æ¯ä¸ªç»„è°ƒç”¨ reduce å‡½æ•° ([i]) => X[i] è¿›è¡Œã€Œå‹ç¼©é™ç»´ã€
  // æ¯æ¬¡ reduce å‡½æ•°æ—¶ï¼Œä¼ å…¥çš„éƒ½æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ˆç”±è¯¥åˆ†ç»„çš„æ‰€æœ‰å…ƒç´ ç»„æˆï¼Œå³è¯¥åˆ†ç»„çš„ç´¢å¼•å€¼æ„æˆçš„ä¸€ä¸ªæ•°ç»„ï¼‰ï¼Œè€Œæœ¬å®ä¾‹ä¸­ï¼Œæ¯ä¸ªåˆ†ç»„å°±åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼ˆä¸€ä¸ªåœ°åå½’ä¸ºä¸€ç»„ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ [i] ç›´æ¥è§£æ„å‡ºç›¸åº”çš„ç´¢å¼•å€¼ï¼Œå¹¶é€šè¿‡ X[i] æ¥è·å–è¯¥åœ°æ–¹å¯¹åº”çš„äººå£ï¼ˆ2019 å¹´- 2010 å¹´ï¼‰å·®å€¼
  // å› æ­¤æœ€ç»ˆæ¯ä¸ªåˆ†ç»„ã€Œå‹ç¼©é™ç»´ã€å¾—åˆ°çš„æ•°æ®æ˜¯è¯¥åœ°æ–¹å¯¹åº”çš„äººå£ï¼ˆ2019 å¹´- 2010 å¹´ï¼‰å·®å€¼

  // å¦‚æœè°ƒç”¨å‡½æ•°æ—¶æ²¡æœ‰è®¾ç½®é«˜åº¦ï¼Œåˆ™åŸºäºæŸ±å­çš„æ•°é‡å’Œä¸Šä¸‹çš„ç•™ç™½å®½åº¦ç®—å‡ºé»˜è®¤çš„ svg çš„é«˜åº¦
  // å…¶ä¸­ yDomain.size å¾—åˆ° InternSet å¯¹è±¡ä¸­åŒ…å«çš„å…ƒç´ ä¸ªæ•°ï¼ˆå³ç±»åˆ«æ•°é‡ï¼‰ï¼Œç„¶åè¿™é‡Œå‡è®¾æ¯ä¸ªæŸ±å­å®½åº¦æ˜¯ 25px
  // å…¶ä¸­åŠ ä¸Š yPadding æ˜¯ä¸ºäº†è€ƒè™‘æŸ±å­é—´å­˜åœ¨çš„é—´éš”
  // é€šè¿‡ Math.ceil() æ–¹æ³•è¿›è¡Œå‘ä¸Šä¿®çº¦ï¼ˆè®© svg ç•™è¶³ç©ºé—´æ¥ç»˜åˆ¶æ¡å½¢å›¾ï¼‰
  if (height === undefined)
    height =
      Math.ceil((yDomain.size + yPadding) * 25) + marginTop + marginBottom;
  // ç„¶åè®¡ç®—å‡ºçºµåæ ‡è½´çš„å€¼åŸŸ [top, bottom]
  if (yRange === undefined) yRange = [marginTop, height - marginBottom];

  // æ¨ªåæ ‡è½´çš„æ•°æ®æ˜¯è¿ç»­å‹çš„æ•°å€¼ï¼Œé»˜è®¤ä½¿ç”¨ d3.scaleLinear æ„å»ºä¸€ä¸ªçº¿æ€§æ¯”ä¾‹å°º
  const xScale = xType(xDomain, xRange);
  // æ¨ªè½´æ˜¯ä¸€ä¸ªï¼ˆåˆ»åº¦å€¼ï¼‰æœä¸Šçš„åæ ‡è½´
  // å¹¶è®¾ç½®åæ ‡è½´çš„åˆ»åº¦æ•°é‡å’Œåˆ»åº¦å€¼æ ¼å¼
  const xAxis = d3.axisTop(xScale).ticks(width / 80, xFormat);

  // çºµåæ ‡è½´çš„æ•°æ®æ˜¯æ¡å½¢å›¾çš„å„ç§åˆ†ç±»ï¼Œä½¿ç”¨ d3.scaleBand æ„å»ºä¸€ä¸ªå¸¦çŠ¶æ¯”ä¾‹å°º
  // å¹¶è®¾ç½®é—´éš”å æ®ï¼ˆæŸ±å­ï¼‰åŒºé—´çš„æ¯”ä¾‹
  const yScale = d3.scaleBand(yDomain, yRange).padding(yPadding);
  // çºµè½´æ˜¯ä¸€ä¸ªï¼ˆåˆ»åº¦å€¼ï¼‰æœå·¦çš„åæ ‡è½´
  // è€Œä¸”å°†åæ ‡è½´çš„åˆ»åº¦ tickSize é•¿åº¦è®¾ç½®ä¸º 0ï¼ˆå³å–æ¶ˆåæ ‡è½´çš„åˆ»åº¦çº¿ï¼‰ï¼Œå¹¶å°†åˆ»åº¦å€¼ä¸è½´çº¿çš„è·ç¦»è®¾ç½®ä¸º 6px
  const yAxis = d3.axisLeft(yScale).tickSize(0).tickPadding(6);

  // æ„å»ºä¸€ä¸ªæ•°å€¼æ ¼å¼å™¨ï¼ˆæ ¹æ®è®¾ç½®æ¥è‡ªåŠ¨ç¡®å®šæ•°æ®çš„ç²¾åº¦ï¼Œæ›´é€‚ç”¨äºé˜…è¯»ï¼‰
  // ç”¨äºå¯¹æŸ±å­çš„æ ‡æ³¨ä¿¡æ¯æˆ–æç¤ºä¿¡æ¯è¿›è¡Œæ ¼å¼åŒ–
  const format = xScale.tickFormat(100, xFormat);

  /**
   *
   * æŸ±å­çš„æç¤ºä¿¡æ¯çš„ accessor function è®¿é—®å‡½æ•°
   * ç»Ÿä¸€ä¸º**åŸºäºç´¢å¼•**è·å–æ•°æ®ç‚¹çš„æç¤ºä¿¡æ¯
   * æç¤ºä¿¡æ¯æ˜¯æŒ‡å½“é¼ æ ‡ hover åœ¨æŸ±å­ä¸Šæ—¶ä¼šæ˜¾ç¤ºç›¸åº”çš„ä¿¡æ¯
   *
   */
  // å¦‚æœè°ƒç”¨å‡½æ•°æ—¶æ²¡æœ‰è®¾å®šæç¤ºä¿¡æ¯çš„ accessor function è®¿é—®å‡½æ•°
  // åˆ™æ„å»ºä¸€ä¸ª accessor function è®¿é—®å‡½æ•°
  // å®ƒæ¥å—ä¸€ä¸ªè¡¨ç¤ºæ•°æ®ç‚¹çš„ç´¢å¼•å€¼ï¼Œå¹¶ä» X ä¸­åˆ†åˆ«æå–å‡ºæŸ±å­ç›¸åº”çš„é¢‘ç‡ç»„æˆæç¤ºä¿¡æ¯
  if (title === undefined) {
    // é»˜è®¤çš„æç¤ºä¿¡æ¯ç”±è¯¥æŸ±å­æ‰€å±çš„ç±»åˆ« Y[i] åŠå…¶ç›¸åº”çš„å€¼ format(X[i]) ç»„æˆï¼ˆ2019 å¹´- 2010 å¹´äººå£å·®å€¼ï¼‰
    title = (i) => `${Y[i]}\n${format(X[i])}`;
  } else if (title !== null) {
    // å¦‚æœè°ƒç”¨å‡½æ•°æ—¶ç”±è®¾å®šæç¤ºä¿¡æ¯çš„ accessor function è®¿é—®å‡½æ•°
    // ä¸ºäº†ä¾¿äºåé¢ç»Ÿä¸€åŸºäºç´¢å¼•å€¼è¿›è¡Œè°ƒç”¨ï¼Œéœ€è¦è¿›è¡Œè½¬æ¢
    // å°† title å˜æˆ**åŸºäºç´¢å¼•**è·å–æ•°æ®ç‚¹çš„æç¤ºä¿¡æ¯çš„ accessor function è®¿é—®å‡½æ•°
    const O = d3.map(data, (d) => d);
    const T = title; // å°†åŸå§‹çš„æç¤ºä¿¡æ¯è®¿é—®å‡½æ•°èµ‹ç»™ T å˜é‡
    title = (i) => T(O[i], i, data); // title å˜æˆåŸºäºç´¢å¼•çš„æç¤ºä¿¡æ¯ accessor function è®¿é—®å‡½æ•°
  }

  /**
   *
   * ç»˜åˆ¶æ¡å½¢å›¾çš„å®¹å™¨ï¼ˆè¾¹æ¡†å’Œåæ ‡è½´ï¼‰
   *
   */
  // ç»˜åˆ¶æ¨ªåæ ‡è½´
  svg
    .append("g")
    // é€šè¿‡è®¾ç½® CSS çš„ transform å±æ€§å°†æ¨ªå‘åæ ‡è½´å®¹å™¨ã€Œç§»åŠ¨ã€åˆ°é¡¶éƒ¨
    .attr("transform", `translate(0,${marginTop})`)
    .call(xAxis) // è°ƒç”¨åæ ‡è½´ï¼ˆå¯¹è±¡ï¼‰æ–¹æ³•ï¼Œå°†åæ ‡è½´åœ¨ç›¸åº”å®¹å™¨å†…éƒ¨æ¸²æŸ“å‡ºæ¥
    .call((g) => g.select(".domain").remove()) // åˆ æ‰ä¸Šä¸€æ­¥æ‰€ç”Ÿæˆçš„åæ ‡è½´çš„è½´çº¿ï¼ˆå®ƒå«æœ‰ domain ç±»åï¼‰
    .call((g) =>
      g
        .selectAll(".tick line")
        .clone() // è¿™é‡Œå¤åˆ¶äº†ä¸€ä»½åˆ»åº¦çº¿ï¼Œç”¨ä»¥ç»˜åˆ¶ç«–å‘çš„å‚è€ƒçº¿
        .attr("y2", height - marginTop - marginBottom) // è°ƒæ•´å¤åˆ¶åçš„åˆ»åº¦çº¿çš„ç»ˆç‚¹ä½ç½®ï¼ˆå¾€ä¸‹ç§»åŠ¨ï¼‰
        .attr("stroke-opacity", 0.1)
    ) // è°ƒå°ç½‘æ ¼çº¿çš„é€æ˜åº¦
    .call((g) =>
      g
        .append("text") // ä¸ºåæ ‡è½´æ·»åŠ é¢å¤–ä¿¡æ¯åç§°ï¼ˆä¸€èˆ¬æ˜¯åˆ»åº¦å€¼çš„å•ä½ç­‰ä¿¡æ¯ï¼‰
        // å°†è¯¥æ–‡æœ¬ç§»åŠ¨åˆ°æ¨ªåæ ‡è½´çš„é›¶ç‚¹ä½ç½®ï¼ˆä¸ä¸€å®šæ˜¯æœ€å·¦ä¾§ï¼‰
        .attr("x", xScale(0))
        .attr("y", -22)
        .attr("fill", "currentColor")
        .attr("text-anchor", "center") // è®¾ç½®æ–‡æœ¬çš„å¯¹é½æ–¹å¼ä¸º centerï¼Œå³æ–‡æœ¬çš„ä¸­é—´å¯¹é½åˆ°æ¨ªåæ ‡è½´çš„é›¶ç‚¹ä½ç½®
        .text(xLabel)
    ); // æ–‡æœ¬å†…å®¹

  // ç»˜åˆ¶çºµåæ ‡è½´
  svg
    .append("g")
    .attr("transform", `translate(${xScale(0)},0)`) // å°†çºµåæ ‡è½´å®¹å™¨å®šä½åˆ°æ¨ªåæ ‡è½´çš„é›¶ç‚¹ä½ç½®
    .call(yAxis)
    .call(
      (g) =>
        // é€‰æ‹©æ‰€æœ‰çš„åˆ»åº¦å€¼
        g
          .selectAll(".tick text")
          .filter((y) => YX.get(y) < 0) // ç­›é€‰å‡ºæ‰€å¯¹åº”çš„æŸ±å­çš„å€¼ä¸ºè´Ÿå€¼çš„åˆ»åº¦å€¼
          // åˆ»åº¦å€¼é»˜è®¤åœ¨çºµè½´çš„å·¦ä¾§ï¼Œå°†è¿™äº›åˆ»åº¦å€¼è°ƒæ•´åˆ°çºµè½´çš„å³ä¾§
          .attr("text-anchor", "start") // å°†æ–‡æœ¬çš„å¯¹é½æ–¹å¼æ”¹å˜ä¸º start
          .attr("x", 6) // å¹¶è®¾ç½®ä¸€ç‚¹æ°´å¹³å‘å³çš„åç§»ï¼ˆ6pxï¼‰
    );

  /**
   *
   * ç»˜åˆ¶æ¡å½¢å›¾å†…çš„æŸ±å­
   *
   */
  const bar = svg
    .append("g")
    // ä½¿ç”¨ <rect> å…ƒç´ æ¥ç»˜åˆ¶æŸ±å­
    // é€šè¿‡è®¾ç½®çŸ©å½¢çš„å·¦ä¸Šè§’ (x, y) åŠå…¶ width å’Œ height æ¥ç¡®å®šå…¶å®šä½å’Œå½¢çŠ¶
    .selectAll("rect")
    .data(I) // ç»‘å®šçš„æ•°æ®æ˜¯è¡¨ç¤ºæ•°æ®ç‚¹çš„ç´¢å¼•å€¼ï¼ˆæ•°ç»„ï¼‰ï¼Œä»¥ä¸‹ä¼šé€šè¿‡ç´¢å¼•å€¼æ¥è·å–å„æŸ±å­ç›¸åº”çš„æ•°æ®
    .join("rect")
    .attr("fill", (i) => colors[X[i] > 0 ? colors.length - 1 : 0]) // åŸºäºæŸ±å­æ‰€å¯¹åº”æ•°æ®çš„æ­£è´Ÿå€¼æ¥é‡‡ç”¨ä¸åŒçš„å¡«å……è‰²
    // å› ä¸ºç»˜åˆ¶çš„æ˜¯æ°´å¹³æ–¹å‘çš„æ¡å½¢å›¾ï¼Œè€Œä¸”æŸ±å­å¯èƒ½æ˜¯å‘å·¦æˆ–å‘å³å»¶ä¼¸çš„ï¼Œæ‰€ä»¥çŸ©å½¢çš„å·¦ä¸Šè§’çš„æ¨ªåæ ‡å€¼ä¸ä¸€å®šæ˜¯ xScale(0)
    // å¯¹äºè¡¨ç¤ºè´Ÿå€¼çš„æŸ±å­ï¼ŒçŸ©å½¢çš„å·¦ä¸Šè§’çš„æ¨ªåæ ‡å€¼å¯¹åº”äº xScale(X[i])
    // å¯¹äºè¡¨ç¤ºæ­£å€¼çš„æŸ±å­ï¼ŒçŸ©å½¢çš„å·¦ä¸Šè§’çš„æ¨ªåæ ‡å€¼å¯¹åº”äº xScale(0)
    // æœ€åé€šè¿‡ Math.min() å–ä¸¤è€…ä¸­çš„æœ€å°å€¼å³ä¸ºå·¦ä¸Šè§’çš„ç‚¹çš„æ¨ªåæ ‡å€¼
    .attr("x", (i) => Math.min(xScale(0), xScale(X[i])))
    // çŸ©å½¢å·¦ä¸Šè§’çš„çºµåæ ‡å€¼
    .attr("y", (i) => yScale(Y[i]))
    // çŸ©å½¢çš„å®½åº¦
    // å³æ°´å¹³æŸ±å­çš„é•¿åº¦ï¼Œé€šè¿‡æ¯”ä¾‹å°ºæ˜ å°„åï¼ŒæŸ±å­çš„å®½åº¦æ˜¯ Math.abs(xScale(X[i]) - xScale(0)) çš„å·®å€¼
    // å› ä¸ºæŸ±å­å¯èƒ½æ˜¯å‘å·¦æˆ–å‘å³å»¶ä¼¸ï¼Œæ‰€ä»¥æœ€å€¼ xScale(X[i]) å¯èƒ½æ¯”é›¶ç‚¹å€¼ xScale(0) æ›´å¤§ï¼Œä¹Ÿå¯ä»¥ä¼šæ›´å°
    // æ‰€ä»¥æœ€åè¦é€šè¿‡æ–¹æ³• Math.abs() å–ç»å¯¹å€¼æ‰æ˜¯æ°´å¹³æŸ±å­çš„é•¿åº¦
    .attr("width", (i) => Math.abs(xScale(X[i]) - xScale(0)))
    // çŸ©å½¢çš„é«˜åº¦
    // å³æŸ±å­çš„å¤§å°ï¼Œé€šè¿‡çºµè½´çš„æ¯”ä¾‹å°ºçš„æ–¹æ³• yScale.bandwidth() è·å– band çš„å®½åº¦ï¼ˆä¸åŒ…å«é—´éš™ paddingï¼‰
    .attr("height", yScale.bandwidth());

  // è®¾ç½®æ¯ä¸ªæŸ±å­çš„æç¤ºä¿¡æ¯
  // åœ¨æ¯ä¸ªæŸ±å­ï¼ˆå®¹å™¨ï¼‰å†…åˆ†åˆ«æ·»åŠ ä¸€ä¸ª <title> å…ƒç´ 
  // å½“é¼ æ ‡ hover åœ¨æŸ±å­ä¸Šæ—¶ä¼šæ˜¾ç¤ºç›¸åº”çš„ä¿¡æ¯
  if (title) bar.append("title").text(title);

  /**
   *
   * è®¾ç½®æ¯ä¸ªæŸ±å­çš„æ ‡æ³¨ä¿¡æ¯
   * å°†æ ‡æ³¨ä¿¡æ¯æ˜¾ç¤ºåœ¨æŸ±å­æ—è¾¹
   *
   */
  svg
    .append("g")
    .attr("text-anchor", "end")
    .attr("font-family", "sans-serif")
    .attr("font-size", 10)
    .selectAll("text")
    .data(I) // ç»‘å®šçš„æ•°æ®æ˜¯è¡¨ç¤ºæ•°æ®ç‚¹çš„ç´¢å¼•å€¼ï¼ˆæ•°ç»„ï¼‰ï¼Œä»¥ä¸‹ä¼šé€šè¿‡ç´¢å¼•å€¼æ¥è·å–å„æŸ±å­ç›¸åº”æ ‡æ³¨ä¿¡æ¯
    .join("text")
    // åŸºäºè¯¥æ ‡æ³¨ä¿¡æ¯æ‰€å¯¹åº”æ•°æ®çš„æ­£è´Ÿå€¼ï¼ˆæŸ±å­å‘å³æˆ–å‘å·¦å»¶ä¼¸ï¼‰ï¼Œè®¾ç½®æ–‡æœ¬çš„å¯¹é½æ–¹å¼
    .attr("text-anchor", (i) => (X[i] < 0 ? "end" : "start"))
    // å°†æ–‡æœ¬ç§»åŠ¨åˆ°ç›¸åº”çš„æŸ±å­ä¸Š
    // æ°´å¹³å®šä½åˆ°æŸ±å­çš„ã€Œé¡¶éƒ¨ã€ï¼Œå¹¶æ ¹æ®æŸ±å­çš„å»¶ä¼¸æ–¹å‘ï¼Œå°†æ–‡æœ¬è¿›è¡Œç›¸åº”çš„ï¼ˆå‘å·¦æˆ–å‘å³çš„ï¼‰åç§»ï¼Œç•™æœ‰ä¸€äº›é—´è·
    // å…¶ä¸­ Math.sign() å‡½æ•°è¿”å› +1ã€-1 æˆ– 0ï¼Œåˆ†åˆ«å…¥å‚çš„å€¼æ˜¯ä¸€ä¸ªæ­£æ•°ã€è´Ÿæ•°æˆ–é›¶
    // ä¾‹å¦‚å½“ X[i] æ˜¯è´Ÿå€¼ï¼ˆå³æŸ±å­æ˜¯å‘å·¦çš„ï¼‰ï¼Œåˆ™  Math.sign(X[i] - 0) å°±è¿”å› -1
    // æ‰€ä»¥æ ‡æ³¨ä¿¡æ¯çš„æ–‡æœ¬æ°´å¹³åç§» -4pxï¼ˆå³å‘å·¦åç§»ï¼‰
    .attr("x", (i) => xScale(X[i]) + Math.sign(X[i] - 0) * 4)
    .attr("y", (i) => yScale(Y[i]) + yScale.bandwidth() / 2)
    .attr("dy", "0.35em")
    .text((i) => format(X[i])); // æ–‡æœ¬å†…å®¹ï¼Œä½¿ç”¨æ•°å€¼æ ¼å¼å™¨ format è¿›è¡Œæ ¼å¼åŒ–ï¼Œä¾¿äºé˜…è¯»

  return svg.node();
}

/**
 *
 * æ„å»º svg
 *
 */
const container = document.getElementById("container"); // å›¾åƒçš„å®¹å™¨

// è·å–å°ºå¯¸å¤§å°
const width = container.clientWidth; // å®½åº¦
const height = container.clientHeight; // é«˜åº¦
const margin = { top: 30, right: 200, bottom: 30, left: 70 };

// åˆ›å»º svg
// åœ¨å®¹å™¨ <div id="container"> å…ƒç´ å†…åˆ›å»ºä¸€ä¸ª SVG å…ƒç´ 
// è¿”å›ä¸€ä¸ªé€‰æ‹©é›†ï¼Œåªæœ‰ svg ä¸€ä¸ªå…ƒç´ 
const svg = d3
  .select("#container")
  .append("svg")
  .attr("width", width)
  .attr("height", height)
  .attr("viewBox", [-margin.left, -margin.top, width, height]);

/**
 *
 * å¼‚æ­¥è·å–æ•°æ®
 * å†åœ¨å›è°ƒå‡½æ•°ä¸­æ‰§è¡Œç»˜åˆ¶æ“ä½œ
 *
 */
// æ•°æ®æ¥æºç½‘é¡µ https://observablehq.com/@d3/horizontal-bar-chart çš„æ–‡ä»¶é™„ä»¶
const dataURL =
  "https://gist.githubusercontent.com/Benbinbin/0b2f44afece4551b579d5bd952eb6671/raw/05838ff20ea1caa46056424650d0a14a857af8fa/state-population-2010-2019.tsv";

d3.tsv(dataURL, d3.autoType).then((data) => {
  // éœ€è¦æ£€æŸ¥ä¸€ä¸‹æ•°æ®è§£æçš„ç»“æœï¼Œå¯èƒ½å¹¶ä¸æ­£ç¡®ï¼Œéœ€è¦åœ¨åé¢çš„æ­¥éª¤é‡Œå†è¿›è¡Œç›¸åº”çš„å¤„ç†
  console.log(data);

  // æ„å»ºæ•£ç‚¹å›¾çŸ©é˜µ
  DivergingBarChart(data, svg, {
    x: (d) => d[2019] - d[2010],
    y: (d) => d.State,
    // è°ƒç”¨å‡½æ•°æ—¶ï¼Œä¼ å…¥çºµè½´çš„å®šä¹‰åŸŸ yDomain æ‰‹åŠ¨è®¾ç½®åˆ†ç»„ç±»åˆ«
    // å¹¶ä¸”ç±»åˆ«æ˜¯æŒ‰ç…§è¯¥åœ°åŒºçš„ 2019 å¹´ä¸ 2010 å¹´äººå£çš„å·®å€¼å¤§å°è¿›è¡Œé™åºæ’åˆ—çš„
    // ä½¿ç”¨æ–¹æ³• d3.groupSort(iterable, accessor, key) å¯¹å¯è¿­ä»£å¯¹è±¡ï¼ˆå¦‚æ•°ç»„ï¼‰iterable è¿›è¡Œå½’ç±»åˆ†ç»„ï¼Œå…¶ä¸­ key æŒ‡å®šåˆ†ç»„çš„ä¾æ®
    // è¯¥æ–¹æ³•é»˜è®¤æŒ‰ç…§ accessor è®¿é—®å™¨çš„è¿”å›å€¼å‡åºæ’åˆ—ï¼Œå³è¾ƒå°çš„å€¼ï¼ˆè´Ÿå€¼ï¼‰æ’åœ¨å‰é¢
    yDomain: d3.groupSort(
      data,
      ([d]) => d[2019] - d[2010],
      (d) => d.State
    ),
    // æ ¼å¼åŒ–æ¨ªåæ ‡è½´çš„åˆ»åº¦å€¼ï¼Œå°†æ•°å€¼å–æ•´ï¼Œå¹¶ä¸ºåƒä½æ·»åŠ é€—å·
    xFormat: "+,d",
    xLabel: "â† decrease Â· Change in population Â· increase â†’",
    marginTop: margin.top,
    marginRight: margin.right,
    marginBottom: margin.bottom,
    marginLeft: margin.left,
    width: width,
    height: height,
    colors: d3.schemeRdBu[3] // è¿™é‡ŒæŒ‡å®šäº†æ­£è´Ÿå€¼çš„æŸ±å­çš„é…è‰²æ–¹æ¡ˆ
  });
});
