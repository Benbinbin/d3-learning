// å‚è€ƒè‡ª https://observablehq.com/@benbinbin/zoomable-bar-chart
// ä¸ç¼©æ”¾æ“ä½œç›¸å…³çš„æ ¸å¿ƒé€»è¾‘
// å°è£…ä¸ºä¸€ä¸ªå‡½æ•°
function zoom(svg) {
  // ç¼©æ”¾äº‹ä»¶çš„å›è°ƒå‡½æ•°
  function zoomed(event) {
    // æ›´æ”¹æ¨ªè½´çš„æ¯”ä¾‹å°º
    // è°ƒç”¨ç¼©æ”¾å˜æ¢å¯¹è±¡ event.transform çš„æ–¹æ³• event.transform.applyX(d)
    // ä¼ å…¥çš„æ˜¯åŸå§‹çš„æ¨ªåæ ‡ d é€šè¿‡ç¼©æ”¾å˜æ¢å¯¹è±¡å¤„ç†ï¼Œè¿”å›å˜æ¢åçš„åæ ‡
    // æ‰€ä»¥ [xmin, xmax].map(d => event.transform.applyX(d)) æ˜¯åŸºäºåŸæ¥çš„æ¨ªè½´å€¼åŸŸï¼Œæ±‚å‡ºç¼©æ”¾å˜æ¢åçš„æ–°å€¼åŸŸ
    // ç„¶åä¿®æ”¹æ¨ªåæ ‡è½´çš„æ¯”ä¾‹å°ºçš„å€¼åŸŸ x.range([newXmin, newXmax])
    // ğŸ’¡ ç¼©æ”¾æ—¶ï¼Œå€¼åŸŸä¸å®šä¹‰åŸŸçš„æ˜ å°„å…³ç³»å°±æ”¹å˜äº†ï¼ˆé¡µé¢ä¸ŠåŸæ¥çš„æŸä¸ªä½ç½®å¯¹åº”äºæŸä¸ªæ•°æ®é‡çš„å…³ç³»ä¸æˆç«‹äº†ï¼‰ï¼Œéœ€è¦æ›´æ–°æ¯”ä¾‹å°ºï¼Œå¯ä»¥è€ƒè™‘æ”¹å˜å€¼åŸŸï¼ˆè¿™é‡Œå°±æ˜¯æ‰‹åŠ¨æ”¹å˜å€¼åŸŸï¼‰ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘æ”¹å˜å®šä¹‰åŸŸ
    // ğŸ’¡ å…¶å® D3 æä¾›äº†æ›´ç®€å•çš„æ–¹æ³• transform.rescaleX(x) æˆ– transform.rescaleY(y)ï¼ˆé€šè¿‡æ”¹å˜å®šä¹‰åŸŸï¼‰æ›´æ–°æ¯”ä¾‹å°º
    // ğŸ’¡ å…³äºæ–¹æ³• transform.rescaleX(x) æˆ– transform.rescaleY(y) çš„ä»‹ç»å¯ä»¥å‚è€ƒè¿™ä¸€ç¯‡ç¬”è®° https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-interact#ç¼©æ”¾å˜æ¢å¯¹è±¡çš„æ–¹æ³•
    x.range(
      [margin.left, width - margin.right].map((d) => event.transform.applyX(d))
    );
    // ä½¿ç”¨æ–°çš„æ¯”ä¾‹å°ºè°ƒæ•´æ¡å½¢å›¾çš„æŸ±å­çš„å®šä½ï¼ˆé€šè¿‡æ”¹å˜æŸ±å­çš„å·¦ä¸Šè§’çš„ x å€¼ï¼‰
    // ä»¥åŠè°ƒæ•´æ¡å½¢å›¾çš„æŸ±å­çš„å®½åº¦ï¼Œé€šè¿‡æ–°çš„æ¯”ä¾‹å°º x.bandwidth() è·å–
    svg
      .selectAll(".bars rect")
      .attr("x", (d) => x(d.name))
      .attr("width", x.bandwidth());
    // ä½¿ç”¨æ–°çš„æ¯”ä¾‹å°ºé‡æ–°ç»˜åˆ¶æ¨ªåæ ‡è½´
    svg.selectAll(".x-axis").call(xAxis);
  }

  // è®¾ç½®å¹³ç§»èŒƒå›´
  // extent æ˜¯ä¸€ä¸ªåµŒå¥—æ•°ç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ¡å½¢å›¾çš„çŸ©å½¢åŒºåŸŸçš„å·¦ä¸Šè§’ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯å³ä¸‹è§’
  const extent = [
    [margin.left, margin.top],
    [width - margin.right, height - margin.top]
  ];

  // åˆ›å»ºç¼©æ”¾å™¨
  const zoomer = d3
    .zoom()
    // çº¦æŸç¼©æ”¾æ¯”ä¾‹çš„èŒƒå›´ï¼Œé»˜è®¤å€¼æ˜¯ [0, âˆ]
    // å…¥å‚æ˜¯ä¸€ä¸ªæ•°ç»„ [1, 8] è¡¨ç¤ºæœ€å°çš„ç¼©æ”¾æ¯”ä¾‹æ˜¯ 1 å€ï¼Œæœ€å¤§çš„ç¼©æ”¾æ¯”ä¾‹æ˜¯ 8 å€
    .scaleExtent([1, 8])
    // çº¦æŸå¹³ç§»çš„èŒƒå›´ translate extentï¼Œé»˜è®¤å€¼æ˜¯ [[-âˆ, -âˆ], [+âˆ, +âˆ]]
    // è¿™é‡Œè®¾ç½®ä¸º extent æ­£å¥½æ˜¯æ¡å½¢å›¾çš„æŸ±å­åŒºåŸŸ
    // æ‰€ä»¥å³ä½¿æ”¾å¤§åï¼Œç”»å¸ƒä¹Ÿåªèƒ½åœ¨æœ€å·¦è¾¹çš„æŸ±å­å’Œæœ€å³è¾¹çš„æŸ±å­ä¹‹é—´ç§»åŠ¨
    .translateExtent(extent)
    // è®¾ç½®è§†å›¾èŒƒå›´ viewport extent
    // å¦‚æœç¼©æ”¾å™¨ç»‘å®šçš„æ˜¯ svgï¼Œåˆ™è§†å›¾èŒƒå›´ viewport extent é»˜è®¤æ˜¯ viewBox
    // è¿™é‡Œã€Œæ ¡æ­£ã€ä¸ºæ¡å½¢å›¾çš„æŸ±å­åŒºåŸŸï¼ˆä¸åŒ…å« margin çš„åŒºåŸŸï¼‰
    .extent(extent)
    .on("zoom", zoomed); // ç¼©æ”¾äº‹ä»¶çš„å›è°ƒå‡½æ•°
  // ğŸ” ä»¥ä¸ŠæåŠçš„è§†å›¾èŒƒå›´ viewport extent å’Œå¹³ç§»èŒƒå›´ translate extent è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹ https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-interact

  svg.call(zoomer); // ä¸º svg æ·»åŠ ç¼©æ”¾äº‹ä»¶ç›‘å¬å™¨
}

/**
 *
 * æ„å»º svg
 *
 */
const container = document.getElementById("container"); // å›¾åƒçš„å®¹å™¨

// è·å–å°ºå¯¸å¤§å°
const width = container.clientWidth; // å®½åº¦
const height = container.clientHeight; // é«˜åº¦
const margin = { top: 20, right: 20, bottom: 30, left: 20 };

// åˆ›å»º svg
// åœ¨å®¹å™¨ <div id="container"> å…ƒç´ å†…åˆ›å»ºä¸€ä¸ª SVG å…ƒç´ 
// è¿”å›ä¸€ä¸ªé€‰æ‹©é›†ï¼Œåªæœ‰ svg ä¸€ä¸ªå…ƒç´ 
const svg = d3
  .select("#container")
  .append("svg")
  .attr("width", width)
  .attr("height", height)
  .attr("viewBox", [0, 0, width, height]);

/**
 *
 * å¼‚æ­¥è·å–æ•°æ®
 * å†åœ¨å›è°ƒå‡½æ•°ä¸­æ‰§è¡Œç»˜åˆ¶æ“ä½œ
 *
 */
// æ•°æ®æ¥æºç½‘é¡µ https://observablehq.com/@benbinbin/zoomable-bar-chart çš„æ–‡ä»¶é™„ä»¶
const dataURL =
  "https://gist.githubusercontent.com/Benbinbin/04f66f9f466d8293c798cefdd8a36021/raw/1339d40a825dddce6c0720ddd01dbea66966577c/alphabet.csv";

d3.csv(dataURL, d3.autoType).then((data) => {
  // éœ€è¦æ£€æŸ¥ä¸€ä¸‹æ•°æ®è§£æçš„ç»“æœï¼Œå¯èƒ½å¹¶ä¸æ­£ç¡®ï¼Œéœ€è¦åœ¨åé¢çš„æ­¥éª¤é‡Œå†è¿›è¡Œç›¸åº”çš„å¤„ç†
  console.log(data);

  /**
   *
   * å¤„ç†æ•°æ®
   *
   */
  // æŒ‰ç…§å­—æ¯çš„ä½¿ç”¨é¢‘ç‡è¿›è¡Œé™åºæ’åˆ—
  const sortData = data
    .map(({ letter, frequency }) => ({ name: letter, value: +frequency }))
    .sort((a, b) => b.value - a.value);

  /**
   *
   * æ„å»ºåæ ‡è½´ä¸æ¯”ä¾‹å°º
   *
   */
  // æ¨ªè½´çš„æ¯”ä¾‹å°º
  // æ¨ªåæ ‡è½´çš„æ•°æ®æ˜¯æ¡å½¢å›¾çš„å„ç§åˆ†ç±»ï¼Œä½¿ç”¨ d3.scaleBand æ„å»ºä¸€ä¸ªå¸¦çŠ¶æ¯”ä¾‹å°º
  x = d3
    .scaleBand()
    .domain(sortData.map((d) => d.name)) // æ¨ªåæ ‡è½´çš„å®šä¹‰åŸŸæ˜¯å­—æ¯çš„åç§°ï¼Œä½œä¸ºåˆ†ç±»çš„ç±»åˆ«
    .range([margin.left, width - margin.right]) // æ¨ªåæ ‡è½´çš„å€¼åŸŸï¼ˆå¯è§†åŒ–å±æ€§ï¼‰æ˜¯é¡µé¢çš„å®½åº¦ [left, right]
    .padding(0.1); // è®¾ç½®æ¡å½¢å›¾ä¸­é‚»è¿‘æŸ±å­ä¹‹é—´çš„é—´éš”å¤§å°

  // æ¨ªåæ ‡è½´å¯¹è±¡
  xAxis = (g) =>
    g
      // é€šè¿‡è®¾ç½® CSS çš„ transform å±æ€§å°†æ¨ªåæ ‡è½´å®¹å™¨å®šä½åˆ°åº•éƒ¨
      .attr("transform", `translate(0,${height - margin.bottom})`)
      // æ¨ªè½´æ˜¯ä¸€ä¸ªæœä¸‹çš„åæ ‡è½´
      // è€Œä¸”å°†åæ ‡è½´çš„å¤–ä¾§åˆ»åº¦ tickSizeOuter é•¿åº¦è®¾ç½®ä¸º 0ï¼ˆå³å–æ¶ˆåæ ‡è½´é¦–å°¾ä¸¤ç«¯çš„åˆ»åº¦ï¼‰
      .call(d3.axisBottom(x).tickSizeOuter(0));

  // çºµè½´çš„æ¯”ä¾‹å°º
  // çºµåæ ‡è½´çš„æ•°æ®æ˜¯è¿ç»­å‹çš„æ•°å€¼ï¼Œé»˜è®¤ä½¿ç”¨ d3.scaleLinear æ„å»ºä¸€ä¸ªçº¿æ€§æ¯”ä¾‹å°º
  y = d3
    .scaleLinear()
    // çºµåæ ‡è½´çš„å®šä¹‰åŸŸ [ymin, ymax] å…¶ä¸­æœ€å¤§å€¼ ymax ä½¿ç”¨æ–¹æ³• d3.max() ä»æ‰€æœ‰æ•°æ®ç‚¹çš„ y å€¼è·å–
    // ç„¶åå†é€šè¿‡ .nice() ç¼–è¾‘å®šä¹‰åŸŸçš„èŒƒå›´ï¼Œé€šè¿‡å››èˆäº”å…¥ä½¿å…¶ä¸¤ç«¯çš„å€¼æ›´ã€Œæ•´é½ã€
    // ä¾¿äºæ˜ å°„åˆ°å€¼åŸŸçš„ï¼ˆåˆ»åº¦ï¼‰å€¼æ›´å…·æœ‰å¯è¯»æ€§
    .domain([0, d3.max(sortData, (d) => d.value)])
    .nice()
    // âš ï¸ åº”è¯¥ç‰¹åˆ«ç•™æ„çºµåæ ‡è½´çš„å€¼åŸŸï¼ˆå¯è§†åŒ–å±æ€§ï¼Œè¿™é‡Œæ˜¯é•¿åº¦ï¼‰èŒƒå›´ [bottom, top]
    // ç”±äº svg çš„åæ ‡ä½“ç³»ä¸­å‘ä¸‹å’Œå‘å³æ˜¯æ­£æ–¹å‘ï¼Œå’Œæˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„ä¸ä¸€è‡´
    // æ‰€ä»¥è¿™é‡Œçš„å€¼åŸŸèŒƒå›´éœ€è¦é‡‡ç”¨ä»ä¸‹å¾€ä¸Šä¸å®šä¹‰åŸŸè¿›è¡Œæ˜ å°„
    .range([height - margin.bottom, margin.top]);

  // çºµåæ ‡è½´å¯¹è±¡
  yAxis = (g) =>
    g
      // é€šè¿‡è®¾ç½® CSS çš„ transform å±æ€§å°†çºµå‘åæ ‡è½´å®¹å™¨ã€Œç§»åŠ¨ã€åˆ°å·¦ä¾§
      .attr("transform", `translate(${margin.left},0)`)
      .call(d3.axisLeft(y)) // çºµè½´æ˜¯ä¸€ä¸ªæœå·¦çš„åæ ‡è½´
      .call((g) => g.select(".domain").remove()); // åˆ æ‰åæ ‡è½´çš„è½´çº¿ï¼ˆå®ƒå«æœ‰ domain ç±»åï¼‰

  /**
   *
   * ç»˜åˆ¶æ¡å½¢å›¾
   *
   */
  // ç»˜åˆ¶æ¡å½¢å›¾å†…çš„æŸ±å­
  svg
    .append("g")
    .attr("class", "bars") // ä¸ºæŸ±å­çš„å®¹å™¨æ·»åŠ ä¸€ä¸ªåä¸º "bars" çš„ class ç±»å
    .attr("fill", "steelblue") // è®¾ç½®æŸ±å­çš„å¡«å……é¢œè‰²
    // ä½¿ç”¨ <rect> å…ƒç´ æ¥ç»˜åˆ¶æŸ±å­
    // é€šè¿‡è®¾ç½®çŸ©å½¢çš„å·¦ä¸Šè§’ (x, y) åŠå…¶ width å’Œ height æ¥ç¡®å®šå…¶å®šä½å’Œå½¢çŠ¶
    .selectAll("rect")
    .data(sortData) // ç»‘å®šæ•°æ®
    .join("rect")
    .attr("x", (d) => x(d.name)) // æŸ±å­çš„å·¦ä¸Šè§’çš„æ¨ªåæ ‡
    .attr("y", (d) => y(d.value)) // æŸ±å­çš„å·¦ä¸Šè§’çš„çºµåæ ‡
    // æŸ±å­çš„é«˜åº¦
    // âš ï¸ åº”è¯¥ç‰¹åˆ«ç•™æ„å› ä¸ºåœ¨ svg çš„åæ ‡ä½“ç³»ä¸­å‘ä¸‹å’Œå‘å³æ˜¯æ­£æ–¹å‘
    // æ‰€ä»¥é€šè¿‡æ¯”ä¾‹å°ºæ˜ å°„åï¼Œåœ¨ svg åæ ‡ä½“ç³»é‡Œï¼ŒæŸ±å­åº•éƒ¨çš„ y å€¼ï¼ˆå³ y(0)ï¼‰æ˜¯å¤§äºæŸ±å­é¡¶éƒ¨çš„ y å€¼ï¼ˆå³ y(d.value)ï¼‰ï¼Œæ‰€ä»¥æŸ±å­çš„é«˜åº¦æ˜¯ y(0) - y(d.value) çš„å·®å€¼
    .attr("height", (d) => y(0) - y(d.value))
    // æŸ±å­çš„å®½åº¦
    // é€šè¿‡æ¨ªè½´çš„æ¯”ä¾‹å°ºçš„æ–¹æ³• x.bandwidth() è·å– band çš„å®½åº¦ï¼ˆä¸åŒ…å«é—´éš™ paddingï¼‰
    // è¿™é‡Œä¸éœ€è¦é€šè¿‡ç´¢å¼•å€¼æ¥è·å–æ¯ä¸ªæŸ±å­çš„å®½åº¦ï¼Œå› ä¸ºæ¯ä¸€ä¸ªæŸ±å­çš„å®½åº¦éƒ½ç›¸åŒ
    .attr("width", x.bandwidth());

  // ç»˜åˆ¶æ¨ªåæ ‡è½´
  svg
    .append("g")
    .attr("class", "x-axis") // ä¸ºæ¨ªåæ ‡è½´å®¹å™¨æ·»åŠ ä¸€ä¸ªåä¸º "x-axis" çš„ class ç±»å
    .call(xAxis); // è°ƒç”¨åæ ‡è½´ï¼ˆå¯¹è±¡ï¼‰æ–¹æ³•ï¼Œå°†åæ ‡è½´åœ¨ç›¸åº”å®¹å™¨å†…éƒ¨æ¸²æŸ“å‡ºæ¥

  // åœ¨ svg çš„å·¦ä¾§æ·»åŠ ä¸€ä¸ªç™½è‰²çš„çŸ©å½¢
  // ä½œä¸ºçºµåæ ‡è½´çš„ã€ŒèƒŒæ™¯ã€
  // è¿™æ ·åœ¨æ”¾å¤§æ¡å½¢å›¾æ—¶ï¼ŒæŸ±å­å³ä½¿ä¼šã€Œå»¶ä¼¸ã€åˆ°çºµè½´åï¼Œä¹Ÿä¼šè¢«ç™½è‰²çŸ©å½¢æ©ç›–ï¼Œå¹¶ä¸ä¼šé˜»ç¢çºµè½´çš„æ˜¾ç¤º
  svg
    .append("rect")
    .attr("x", 0)
    .attr("y", 0)
    .attr("width", margin.left)
    .attr("height", height)
    .attr("fill", "white");

  // ç»˜åˆ¶çºµåæ ‡è½´
  svg
    .append("g")
    .attr("class", "y-axis") // ä¸ºçºµåæ ‡è½´å®¹å™¨æ·»åŠ ä¸€ä¸ªåä¸º "y-axis" çš„ class ç±»å
    .call(yAxis); // è°ƒç”¨åæ ‡è½´ï¼ˆå¯¹è±¡ï¼‰æ–¹æ³•ï¼Œå°†åæ ‡è½´åœ¨ç›¸åº”å®¹å™¨å†…éƒ¨æ¸²æŸ“å‡ºæ¥

  /**
   *
   * è°ƒç”¨ zoom å‡½æ•°ï¼ˆå¹¶ä¼ å…¥ svg ä½œä¸ºå‚æ•°ï¼‰
   */
  svg.call(zoom);
});
