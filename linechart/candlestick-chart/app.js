// å‚è€ƒè‡ª https://observablehq.com/@d3/candlestick-chart/2

/**
 *
 * æ„å»º svg
 *
 */
const container = document.getElementById("container"); // å›¾åƒçš„å®¹å™¨

// è·å–å°ºå¯¸å¤§å°
const width = container.clientWidth; // å®½åº¦
const height = container.clientHeight; // é«˜åº¦
// margin ä¸ºå‰ç¼€çš„å‚æ•°
// å…¶ä½œç”¨æ˜¯åœ¨ svg çš„å¤–å‘¨ç•™ç™½ï¼Œæ„å»ºä¸€ä¸ªæ˜¾ç¤ºçš„å®‰å…¨åŒºï¼Œä»¥ä¾¿åœ¨å››å‘¨æ˜¾ç¤ºåæ ‡è½´
const marginTop = 20;
const marginRight = 30;
const marginBottom = 30;
const marginLeft = 40;

// åˆ›å»º svg
// åœ¨å®¹å™¨ <div id="container"> å…ƒç´ å†…åˆ›å»ºä¸€ä¸ª SVG å…ƒç´ 
// è¿”å›ä¸€ä¸ªé€‰æ‹©é›†ï¼Œåªæœ‰ svg ä¸€ä¸ªå…ƒç´ 
const svg = d3
  .select("#container")
  .append("svg")
  .attr("width", width)
  .attr("height", height)
  .attr("viewBox", [0, 0, width, height]);

/**
 *
 * å¼‚æ­¥è·å–æ•°æ®
 * å†åœ¨å›è°ƒå‡½æ•°ä¸­æ‰§è¡Œç»˜åˆ¶æ“ä½œ
 *
 */
// æ•°æ®æ¥æº Observable ä¸€ä¸ªå†…ç½®çš„æ•°æ®é›†ï¼ˆåœ¨æ ‡å‡†åº“ä¸­ï¼‰appl
// ç›¸å…³ä»‹ç»å¯å‚è€ƒ https://observablehq.com/@observablehq/sample-datasets?collection=@observablehq/getting-data-in-and-out
// è¿™æå–äº†æœ€åçš„ 130 ä¸ªæ•°æ®ç‚¹è¿›è¡Œå¯è§†åŒ–
const dataURL =
  "https://gist.githubusercontent.com/Benbinbin/03851c822109259ae51da278a017a3e1/raw/83bf854d8b7a556451e7903ba7136da392d24174/ticker.csv";

d3.csv(dataURL, d3.autoType).then((ticker) => {
  // éœ€è¦æ£€æŸ¥ä¸€ä¸‹æ•°æ®è§£æçš„ç»“æœï¼Œå¯èƒ½å¹¶ä¸æ­£ç¡®ï¼Œéœ€è¦åœ¨åé¢çš„æ­¥éª¤é‡Œå†è¿›è¡Œç›¸åº”çš„å¤„ç†
  console.log(ticker);

  /**
   *
   * æ„å»ºæ¯”ä¾‹å°º
   *
   */
  // è®¾ç½®æ¨ªåæ ‡è½´çš„æ¯”ä¾‹å°º
  // æ¨ªåæ ‡è½´çš„æ•°æ®æ˜¯ä¸åŒçš„æ—¥æœŸï¼ˆè¿™é‡Œçœ‹ä½œä¸åŒçš„ç±»åˆ«ï¼‰ï¼Œä½¿ç”¨ d3.scaleBand æ„å»ºä¸€ä¸ªå¸¦çŠ¶æ¯”ä¾‹å°º
  // ä½¿ç”¨ d3-scale æ¨¡å—
  // å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-scale/band
  // æˆ–è¿™ä¸€ç¯‡ç¬”è®° https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-scale#å¸¦çŠ¶æ¯”ä¾‹å°º-band-scales
  // ğŸ’¡ è¿™é‡Œæ¨ªåæ ‡ä½¿ç”¨å¸¦çŠ¶æ¯”ä¾‹å°ºï¼Œè€Œä¸æ˜¯åƒä¸€èˆ¬çš„æŠ˜çº¿å›¾ä½¿ç”¨è¿ç»­å‹æ¯”ä¾‹å°º
  // ğŸ’¡ è™½ç„¶èœ¡çƒ›çº¿è™½ç„¶æ•´ä½“çœ‹èµ·æ¥å’ŒæŠ˜çº¿å›¾ç±»ä¼¼ï¼Œä½†æ˜¯ç»˜åˆ¶çš„æµç¨‹å’Œä»£ç åˆ™æ˜¯ä¸æŒ‘é€‰å›¾ç±»ä¼¼ï¼Œå› ä¸ºæ¯ä¸ªã€Œèœ¡çƒ›å›¾å½¢ã€éƒ½å æœ‰ä¸€å®šçš„å®½åº¦ï¼Œå’ŒæŸ±çŠ¶å›¾çš„æ¡å¸¦ç±»ä¼¼
  const x = d3.scaleBand()
    // è®¾ç½®å®šä¹‰åŸŸèŒƒå›´
    // ä»æ•°æ®é›†ä¸­è·å–æ—¥æœŸèŒƒå›´ï¼ˆç”Ÿæˆä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«ä¸€ç³»åˆ—çš„æ—¥æœŸï¼‰
    // å…¶ä¸­ d3.utcDay æ˜¯ä¸€ä¸ªæ—¶é—´è¾¹è·è®¡ç®—å™¨ï¼ˆä»¥ä¸‹ç§°ä¸º intervalï¼‰ï¼Œç”¨äºç”Ÿæˆç‰¹å®šé—´è·çš„æ—¶é—´
    // å…·ä½“å‚è€ƒ d3-time æ¨¡å—çš„å®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-time
    // æˆ–è¿™ä¸€ç¯‡ç¬”è®° https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-data-process#æ—¶é—´è¾¹è·è®¡ç®—å™¨
    // d3.utcDay æ˜¯ä»¥ã€Œå¤©ã€ä¸ºé—´è·çš„ intervalï¼Œæ—¶é—´æ ¼å¼é‡‡ç”¨ UTC ä¸–ç•Œåè°ƒæ—¶é—´
    // è°ƒç”¨æ–¹æ³• interval.range(start, stop[, step]) è¿”å›ä¸€ä¸ªåŒ…å«ä¸€ç³»åˆ— Date å¯¹è±¡çš„æ•°ç»„
    // å…¶ä¸­ç¬¬ä¸€ä¸ªã€ç¬¬äºŒä¸ªå‚æ•° startï¼ˆåŒ…å«ï¼‰ å’Œ stopï¼ˆä¸åŒ…æ‹¬ï¼‰ç”¨äºè®¾ç½®æ—¶é—´èŒƒå›´
    // ç¬¬ä¸‰ä¸ªï¼ˆå¯é€‰ï¼‰å‚æ•° step æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œç”¨äºè®¾ç½®æ­¥é•¿ï¼Œå³æ¯è·ç¦»å¤šé•¿çš„æ—¶é—´é‡‡é›†ä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œç”Ÿæˆä¸€ä¸ª Date å¯¹è±¡ï¼Œé»˜è®¤å€¼ä¸º 1
    // ç”±äºæ•°æ®é›† ticker çš„å…ƒç´ å·²ç»æŒ‰æ—¶é—´é¡ºåºè¿›è¡Œæ’åºï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡ç¬¬ä¸€ä¸ªå…ƒç´  ticker.at(0) å’Œæœ€åä¸€ä¸ªå…ƒç´  ticker.at(-1) è·å–åˆ°æ•°æ®é›†çš„æ—¶é—´èŒƒå›´
    // å†åˆ†åˆ«æå–å‡ºæ—¶é—´å¯¹è±¡ element.Date ä½œä¸ºæ–¹æ³• interval.range(start, stop) ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒå‚æ•°
    // âš ï¸ ç”±äºæ–¹æ³• interval.range(start, stop) æ‰€ç”Ÿæˆçš„ä¸€ç³»åˆ— Date å¯¹è±¡ä¸­ï¼Œå¹¶ä¸åŒ…å«ç¬¬äºŒä¸ªå‚æ•° stop æ‰€æŒ‡å®šçš„æ—¶é—´
    // æ‰€ä»¥è¿™é‡Œä¸èƒ½ç›´æ¥ä¼ å…¥ ticker.at(-1).Dateï¼ˆå®ƒæ˜¯ä¸€ä¸ª Date å¯¹è±¡ï¼‰ï¼Œè€Œæ˜¯è¦å°†å®ƒé€‚å½“ã€Œå»¶é•¿ã€ï¼Œè¿™é‡Œå°±å…ˆå°† Date å¯¹è±¡è½¬æ¢ä¸ºæ¯«ç§’æ•°  +ticker.at(-1).Date å†åŠ ä¸Š 1 æ¯«ç§’ï¼Œè¿™æ ·å°±ä¿è¯äº†æ‰€ç”Ÿæˆçš„ä¸€ç³»åˆ— Date å¯¹è±¡ä¸­åŒ…å«æ•°æ®é›†æ‰€æœ‰æ—¶é—´ç‚¹
    // ç„¶åé€šè¿‡ arr.filter() å°†æ•°æ®é›†ä¸­çš„æ—¥æœŸè¿›è¡Œç­›é€‰è¿‡æ»¤
    // ç”±äº interval æ˜¯ä»¥ã€Œå¤©ã€ä¸ºé—´éš”ï¼Œæ‰€ä»¥ä» start è‡³ stopï¼ˆä¸åŒ…å«ï¼‰èŒƒå›´ä¸­çš„æ‰€æœ‰æ—¥æœŸéƒ½åŒ…å«åœ¨å†…
    // ä½†æ˜¯å› ä¸ºå‘¨å…­æ—¥è‚¡ç¥¨å¸‚åœºå¹¶æ²¡æœ‰äº¤æ˜“ï¼Œæ‰€ä»¥åœ¨æ•°æ®é›†ä¸­æ˜¯æ²¡æœ‰å¯¹åº”çš„è‚¡ä»·æ•°æ®çš„
    // æ‰€ä»¥éœ€è¦å°†è¿™äº›æ—¥æœŸä»æ•°ç»„ä¸­åˆ æ‰ï¼Œä»¥é¿å…ç»˜åˆ¶èœ¡çƒ›çº¿æ—¶å‡ºç°ç©ºç™½æ–­è¿çš„æƒ…å†µ
    // é€šè¿‡è°ƒç”¨ Date å¯¹è±¡çš„æ–¹æ³• date.getUTCDay() æ‰€è¿”å›çš„æ•°å€¼ï¼Œåˆ¤å®šè¯¥æ—¥æœŸå¯¹åº”å‘¨å‡ 
    // å‘¨æ—¥å¯¹åº”çš„æ˜¯ 0ï¼Œå‘¨å…­å¯¹åº”çš„æ˜¯ 6ï¼Œè¦ç­›æ‰è¿™äº›æ—¶é—´å¯¹è±¡
    .domain(d3.utcDay
      .range(ticker.at(0).Date, +ticker.at(-1).Date + 1)
      .filter(d => d.getUTCDay() !== 0 && d.getUTCDay() !== 6))
    // è®¾ç½®å€¼åŸŸèŒƒå›´ï¼ˆæ‰€æ˜ å°„çš„å¯è§†å…ƒç´ ï¼‰
    // svg å…ƒç´ çš„å®½åº¦ï¼ˆå‡å»ç•™ç™½åŒºåŸŸï¼‰
    .range([marginLeft, width - marginRight])
    .padding(0.1); // å¹¶è®¾ç½®é—´éš”å æ®ï¼ˆæŸ±å­ï¼‰åŒºé—´çš„æ¯”ä¾‹

  // è®¾ç½®çºµåæ ‡è½´çš„æ¯”ä¾‹å°º
  // çºµåæ ‡è½´çš„æ•°æ®æ˜¯è¿ç»­å‹çš„æ•°å€¼ï¼ˆè‚¡ä»·ï¼‰ï¼Œä½¿ç”¨ d3.scaleLog æ„å»ºä¸€ä¸ªå¯¹æ•°æ¯”ä¾‹å°º
  // è¿™é‡Œé‡‡ç”¨å¯¹æ•°æ¯”ä¾‹å°ºçš„åŸå›  â“
  // æ•°æ®/è‚¡ä»·çš„æ³¢åŠ¨/å·®è·å¹¶ä¸å¤§ï¼Œæ˜¯å¦ä¹Ÿå¯ä»¥ä½¿ç”¨ d3.scaleLinear() æ„å»ºçº¿æ€§æ¯”ä¾‹å°º â“
  const y = d3.scaleLog()
    // è®¾ç½®å®šä¹‰åŸŸèŒƒå›´ [ymin, ymax] âš ï¸ æœ€å°å€¼å¹¶ä¸æ˜¯ä» 0 å¼€å§‹
    // æœ€å°å€¼æ˜¯ä»æ•°æ®é›†ä¸­çš„æ¯ä¸ªæ•°æ®ç‚¹çš„å±æ€§ d.Lowï¼ˆå½“å¤©çš„æœ€ä½è‚¡ä»·ï¼‰è·å–ï¼Œå–å…¶ä¸­çš„æœ€å°å€¼
    // æœ€å¤§å€¼æ˜¯ä»æ•°æ®é›†ä¸­çš„æ¯ä¸ªæ•°æ®ç‚¹çš„å±æ€§ d.Highï¼ˆå½“å¤©æœ€é«˜è‚¡ä»·ï¼‰è·å–ï¼Œå–å…¶ä¸­çš„æœ€å¤§å€¼
    .domain([d3.min(ticker, d => d.Low), d3.max(ticker, d => d.High)])
    // è®¾ç½®å€¼åŸŸèŒƒå›´
    // svg å…ƒç´ çš„é«˜åº¦ï¼ˆå‡å»ç•™ç™½åŒºåŸŸï¼‰
    .rangeRound([height - marginBottom, marginTop]);

  /**
   *
   * ç»˜åˆ¶åæ ‡è½´
   *
   */
  // ç»˜åˆ¶æ¨ªåæ ‡è½´
  svg.append("g")
    // é€šè¿‡è®¾ç½® CSS çš„ transform å±æ€§å°†æ¨ªåæ ‡è½´å®¹å™¨ã€Œç§»åŠ¨ã€åˆ°åº•éƒ¨
    .attr("transform", `translate(0,${height - marginBottom})`)
    // æ¨ªè½´æ˜¯ä¸€ä¸ªåˆ»åº¦å€¼æœä¸‹çš„åæ ‡è½´
    .call(d3.axisBottom(x)
      // è‡ªå®šä¹‰åæ ‡è½´çš„åˆ»åº¦å€¼
      // é€šè¿‡ axis.tickValues([values]) ä¼ é€’ä¸€ä¸ªæ•°ç»„ï¼Œç”¨å…¶ä¸­çš„å…ƒç´ è¦†ç›–æ¯”ä¾‹å°ºè‡ªåŠ¨ç”Ÿæˆçš„åˆ»åº¦å€¼
      // d3.utcMonday æ˜¯ä¸€ä¸ªæ—¶é—´è¾¹è·è®¡ç®—å™¨ï¼ˆä»¥ä¸‹ç§°ä¸º intervalï¼‰ï¼Œç”¨äºç”Ÿæˆç‰¹å®šé—´è·çš„æ—¶é—´ï¼ˆä¸€ç³»åˆ— Date å¯¹è±¡çš„æ•°ç»„ï¼‰
      // d3.utcMonday æ˜¯ä»¥ã€Œå‘¨ã€ä¸ºé—´è·çš„ intervalï¼Œä¸”ä»¥å‘¨ä¸€ä¸ºæ¯ä¸€å‘¨çš„å¼€å§‹ï¼Œæ—¶é—´æ ¼å¼é‡‡ç”¨ UTC ä¸–ç•Œåè°ƒæ—¶é—´
      // æ–¹æ³• interval.every(step) å¯ä»¥åŸºäºåŸæœ‰çš„é‡‡é›†æ—¶é—´é—´éš”ï¼Œè¿›ä¸€æ­¥å®ç°å¿«æ·çš„å®šåˆ¶ï¼Œç›¸å½“äºæŒ‰ç…§ç‰¹å®šçš„æ­¥é•¿ step å¯¹æ‰€ç”Ÿæˆçš„æ•°ç»„è¿›è¡ŒäºŒæ¬¡é‡‡é›†ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ svg å®½åº¦è¾ƒå°æ—¶ï¼Œå‡å°‘æ‰€ç”Ÿæˆçš„åˆ»åº¦æ•°é‡
      // è¿™é‡Œ width > 720 ? 1 : 2 æ˜¯æŒ‡æ ¹æ® svg çš„å®½åº¦ï¼Œè®¾ç½®ä¸åŒçš„é‡‡é›†æ­¥é•¿ï¼Œå¦‚æœå®½åº¦å¤§äº 720px æ­¥é•¿ä¸º 1ï¼Œå°±ç›¸å½“äºé‡‡ç”¨åŸæœ¬ç”Ÿæˆçš„æ•°ç»„ï¼Œå¦‚æœå®½åº¦å°äº 720px æ­¥é•¿ä¸º 2ï¼Œåˆ™ç›¸éš”ä¸€ä¸ªå…ƒç´ è¿›è¡ŒäºŒæ¬¡é‡‡é›†
      // è°ƒç”¨æ–¹æ³• interval.range(start, stop) ç”Ÿæˆä¸€ç³»åˆ— Date å¯¹è±¡ï¼ˆç”¨æ•°ç»„åŒ…å«ï¼‰
      .tickValues(d3.utcMonday
        .every(width > 720 ? 1 : 2)
        .range(ticker.at(0).Date, ticker.at(-1).Date))
      // é€šè¿‡ axis.tickFormat() è®¾ç½®åˆ»åº¦å€¼æ ¼å¼
      // ç”±äºå‰é¢æ‰€è®¾ç½®çš„åˆ»åº¦å€¼æ˜¯ Date æ—¥æœŸå¯¹è±¡ï¼Œé»˜è®¤è½¬æ¢ç”Ÿæˆçš„å­—ç¬¦ä¸²å¾ˆå¤æ‚ï¼Œå¯è¯»æ€§å¾ˆä½ï¼Œä¸é€‚åˆç›´æ¥ä½œä¸ºåˆ»åº¦å€¼
      // æ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† d3.utcFormat() æ„å»ºä¸€ä¸ªæ—¶é—´æ ¼å¼å™¨ï¼Œç”¨äºå°†æ—¥æœŸå¯¹è±¡è½¬å˜ä¸ºç‰¹å®šæ ¼å¼çš„å­—ç¬¦ä¸²
      // å…·ä½“å‚è€ƒ d3-time-format æ¨¡å—çš„å®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-time-format
      // æˆ–è¿™ä¸€ç¯‡ç¬”è®° https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-data-process#æ—¶é—´æ ¼å¼å™¨
      // æ ¼å¼å™¨çš„å‚æ•° %-m/%-d ç§°ä¸º specifier æ—¶é—´æ ¼å¼è¯´æ˜ç¬¦ï¼Œå®ƒç±»ä¼¼äºæ­£åˆ™è¡¨è¾¾å¼ï¼Œç”±ä¸€ç³»åˆ—æŒ‡ä»¤æ„æˆ
      // å…¶ä¸­ %-m è¡¨ç¤ºæœˆä»½ï¼Œè€Œ %-d è¡¨ç¤ºæ—¥æœŸï¼Œå…¶ä¸­çš„æ¨ªçº¿ - è¡¨ç¤ºå¦‚æœæœˆä»½æˆ–æ—¥æœŸç”¨æ•°å€¼è¡¨ç¤ºæ˜¯ä¸€ä½æ•°æ—¶ï¼ˆä¾‹å¦‚ 1 æœˆ 1 æ—¥ï¼‰ä¸å¿…ç”¨ 0 å¡«å……æˆä¸¤ä½æ•°ï¼ˆè¿™æ˜¯é»˜è®¤è¡Œä¸ºï¼‰ï¼Œç„¶åè¿™ä¸¤ä¸ªæ•°å€¼ç”¨ / æ–œçº¿åˆ†éš”
      .tickFormat(d3.utcFormat("%-m/%-d")))
    // åˆ æ‰ä¸Šä¸€æ­¥æ‰€ç”Ÿæˆçš„åæ ‡è½´çš„è½´çº¿ï¼ˆå®ƒå«æœ‰ domain ç±»åï¼‰
    .call(g => g.select(".domain").remove());
  // ğŸ’¡ æ³¨æ„ä»¥ä¸Šé€šè¿‡æ–¹æ³• selection.call(axis) çš„æ–¹å¼æ¥è°ƒç”¨åæ ‡è½´å¯¹è±¡ï¼ˆæ–¹æ³•ï¼‰
  // ä¼šå°†é€‰æ‹©é›†ä¸­çš„å…ƒç´  <g> ä¼ é€’ç»™åæ ‡è½´å¯¹è±¡çš„æ–¹æ³•ï¼Œä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°
  // ä»¥ä¾¿å°†åæ ‡è½´åœ¨ç›¸åº”å®¹å™¨å†…éƒ¨æ¸²æŸ“å‡ºæ¥
  // å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-selection/control-flow#selection_call
  // æˆ–è¿™ä¸€ç¯‡æ–‡æ¡£ https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-data-binding#å…¶ä»–æ–¹æ³•

  // ç»˜åˆ¶çºµåæ ‡è½´
  svg.append("g")
    // é€šè¿‡è®¾ç½® CSS çš„ transform å±æ€§å°†çºµå‘åæ ‡è½´å®¹å™¨ã€Œç§»åŠ¨ã€åˆ°å·¦ä¾§
    .attr("transform", `translate(${marginLeft},0)`)
    // çºµè½´æ˜¯ä¸€ä¸ªåˆ»åº¦å€¼æœå·¦çš„åæ ‡è½´
    .call(d3.axisLeft(y)
      // é€šè¿‡ axis.tickFormat() è®¾ç½®åˆ»åº¦å€¼æ ¼å¼
      // è¿™é‡Œä½¿ç”¨äº† d3.format() æ„å»ºä¸€ä¸ªæ•°å€¼æ ¼å¼å™¨ï¼Œå¯¹æ•°å­—è¿›è¡Œä¿®çº¦ç­‰å¤„ç†ï¼Œç”Ÿæˆæ›´æ˜“äºé˜…è¯»çš„åˆ»åº¦å€¼
      // å…·ä½“å‚è€ƒ d3-format æ¨¡å—çš„å®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-format
      // æ ¼å¼å™¨çš„å‚æ•° $~f ç§°ä¸º specifier æ•°å­—æ ¼å¼è¯´æ˜ç¬¦ï¼Œå®ƒç±»ä¼¼äºæ­£åˆ™è¡¨è¾¾å¼ï¼Œç”±ä¸€ç³»åˆ—æŒ‡ä»¤æ„æˆ
      // å…¶ä¸­ $ è¡¨ç¤ºåœ¨æ•°å€¼å‰é¢æ·»åŠ é‡‘é’±ï¼ˆç¾å…ƒï¼‰ç¬¦å·ï¼Œè€Œ ~ è¡¨ç¤ºåˆ æ‰æ— ç”¨çš„é›¶ï¼ˆä¾‹å¦‚ä½äºå°æ•°ç‚¹åé¢çš„æœ€åçš„ä¸€äº›é›¶ï¼Œä¸€èˆ¬åªæ˜¯ç”¨äºè¡¨ç¤ºç²¾åº¦ï¼‰
      // å…¶ä¸­ f è¡¨ç¤ºéœ€è¦å°†æ•°å€¼çš„å°æ•°ç‚¹æ•°é‡å›ºå®šåˆ°å‡ ä½ï¼Œä½†æ˜¯è¿™é‡Œå®ƒçš„å‰é¢å¹¶æ²¡æœ‰ç»™å®šæ•°å€¼ï¼Œæ‰€ä»¥æˆªå–åˆ°æ•´æ•°ï¼Œèˆå¼ƒå°æ•°ç‚¹åé¢çš„æ•°å€¼
      .tickFormat(d3.format("$~f"))
      // è‡ªå®šä¹‰åæ ‡è½´çš„åˆ»åº¦å€¼
      // é€šè¿‡ axis.tickValues([values]) ä¼ é€’ä¸€ä¸ªæ•°ç»„ï¼Œç”¨å…¶ä¸­çš„å…ƒç´ è¦†ç›–æ¯”ä¾‹å°ºè‡ªåŠ¨ç”Ÿæˆçš„åˆ»åº¦å€¼
      // è¿™é‡Œåˆ›å»ºä¸€ä¸ªçº¿æ€§æ¯”ä¾‹å°º d3.scaleLinear() æ¥è®¡ç®—/ç”Ÿæˆåˆ»åº¦å€¼
      // å…¶å®šä¹‰åŸŸä¸ y æ¯”ä¾‹å°ºï¼ˆå¯¹æ•°æ¯”ä¾‹å°ºï¼‰ä¸€æ ·ï¼ˆå¤ç”¨ï¼‰ï¼Œå…¶èŒƒå›´ä¹Ÿæ˜¯è‚¡ä»·çš„æœ€ä½å€¼å’Œæœ€é«˜å€¼
      // ç„¶åä½¿ç”¨ scale.ticks() ç”Ÿæˆä¸€ä¸ªæ•°ç»„
      // è¯¥æ–¹æ³•å¯ä»¥ä¼ å…¥ä¸€ä¸ªæ•°å­—ä½œä¸ºå¯é€‰å‚æ•°ï¼Œä»¥æŒ‡å®šç”Ÿæˆå¤šå°‘ä¸ªåˆ»åº¦å€¼ï¼Œé»˜è®¤å…ƒç´ çš„æ•°é‡æ˜¯ 10ï¼ˆä¸è¿‡å®é™…ä¸Š D3 ä¼šæ ¹æ®æ¯”ä¾‹å°ºçš„ç±»å‹å’Œå®šä¹‰åŸŸçš„èŒƒå›´è¿›è¡Œè°ƒæ•´ï¼Œä»¥ä¾¿ç”Ÿæˆçš„åˆ»åº¦å€¼æ›´æ˜“äºé˜…è¯»ï¼Œè®©åˆ»åº¦å€¼æ›´å…·æœ‰è§„å¾‹ï¼Œä¾‹å¦‚ 5 æˆ– 10 çš„å€æ•°ï¼‰
      // è¿™é‡Œåˆ›å»ºä¸€ä¸ªçº¿æ€§æ¯”ä¾‹å°ºç”¨äºé‡æ–°ç”Ÿæˆåˆ»åº¦å€¼çš„åŸå›  â“
      // ä¸¤ä¸ªæ¯”ä¾‹å°ºï¼ˆçº¿æ€§æ¯”ä¾‹å°ºå’Œå¯¹æ•°æ¯”ä¾‹å°ºï¼‰ç”Ÿæˆçš„åˆ»åº¦å€¼å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«
      .tickValues(d3.scaleLinear().domain(y.domain()).ticks()))
    .call(g => g.selectAll(".tick line").clone() // è¿™é‡Œå¤åˆ¶äº†ä¸€ä»½åˆ»åº¦çº¿ï¼Œç”¨ä»¥ç»˜åˆ¶æ¨ªå‘çš„å‚è€ƒçº¿
      .attr("stroke-opacity", 0.2) // è°ƒå°å‚è€ƒçº¿çš„é€æ˜åº¦
      .attr("x2", width - marginLeft - marginRight)) // è°ƒæ•´å¤åˆ¶åçš„åˆ»åº¦çº¿çš„ç»ˆç‚¹ä½ç½®ï¼ˆå¾€å³ç§»åŠ¨ï¼‰
    // åˆ æ‰ä¸Šä¸€æ­¥æ‰€ç”Ÿæˆçš„åæ ‡è½´çš„è½´çº¿ï¼ˆå®ƒå«æœ‰ domain ç±»åï¼‰
    .call(g => g.select(".domain").remove());

  /**
   *
   * ç»˜åˆ¶èœ¡çƒ›çº¿
   *
   */
  // ä¸ºå®ƒä»¬åˆ›å»ºä¸€ä¸ªå¤§å®¹å™¨
  const g = svg.append("g")
    // è®¾ç½®çº¿æ®µè·¯å¾„ç«¯ç‚¹çš„æ ·å¼
    .attr("stroke-linecap", "round")
    // è®¾ç½®çº¿æ®µæè¾¹é¢œè‰²
    .attr("stroke", "black")
    // ä¸ºæ¯ä¸ªèœ¡çƒ›å›¾å½¢è®¾ç½®ä¸€ä¸ªå®¹å™¨
    .selectAll("g")
    // ç»‘å®šæ•°æ®
    .data(ticker)
    .join("g") // å°†è¿™äº›å®¹å™¨ç»˜åˆ¶åˆ°é¡µé¢ä¸Š
    // å¹¶é€šè¿‡è®¾ç½® CSS çš„ transform å±æ€§ï¼Œå°†å®ƒä»¬åˆ†åˆ«æ²¿ç€æ¨ªåæ ‡ç§»åŠ¨åˆ°ç›¸åº”çš„ä½ç½®
    // åŸºäºæ‰€ç»‘å®šæ•°æ®ï¼ˆä¸€ä¸ªå¯¹è±¡ï¼‰çš„å±æ€§ d.Dateï¼Œå¹¶ä½¿ç”¨ x æ¯”ä¾‹å°ºè¿›è¡Œæ˜ å°„ x(d.Date) å¾—åˆ°åœ¨æ°´å¹³æ–¹å‘ä¸Šçš„åç§»é‡
    .attr("transform", d => `translate(${x(d.Date)},0)`);

  // ç»˜åˆ¶ä¸€æ¡çº¿æ®µè¡¨ç¤ºæœ€ä½ä»·å’Œæœ€é«˜ä»·
  g.append("line") // ä½¿ç”¨ <line> å…ƒç´ ç»˜åˆ¶çº¿æ®µ
    // åªè®¾ç½®çº¿æ®µçš„èµ·å§‹ç‚¹å’Œç»ˆæ­¢ç‚¹çš„çºµåæ ‡å€¼
    // ç”±äºæ˜¯å‚ç›´å‘ä¸‹çš„ç›´çº¿ï¼Œæ‰€ä»¥å¯ä»¥æ¨ªåæ ‡å€¼é‡‡ç”¨é»˜è®¤å€¼ï¼ˆéƒ½æ˜¯ 0ï¼‰ï¼Œè€Œå‰é¢ â˜ï¸ åœ¨å®¹å™¨ä¸Šè®¾ç½®äº†æ¨ªå‘çš„åç§»ï¼Œæ‰€ä»¥å®é™…ä¸Šçº¿æ®µåœ¨æ°´å¹³æ–¹å‘ä¹Ÿä¼šç§»åˆ°ç›¸åº”çš„ä½ç½®
    .attr("y1", d => y(d.Low)) // åŸºäºæœ€ä½ä»·ï¼Œå¹¶é€šè¿‡çºµåæ ‡è½´çš„æ¯”ä¾‹å°º y è¿›è¡Œæ˜ å°„ï¼Œå¾—åˆ°èµ·å§‹ç‚¹çš„çºµåæ ‡å€¼
    .attr("y2", d => y(d.High)); // åŸºäºæœ€é«˜ä»·ï¼Œå¹¶é€šè¿‡çºµåæ ‡è½´çš„æ¯”ä¾‹å°º y è¿›è¡Œæ˜ å°„ï¼Œå¾—åˆ°ç»ˆæ­¢ç‚¹çš„çºµåæ ‡å€¼

  // ç»˜åˆ¶ä¸€æ¡çº¿æ®µè¡¨ç¤ºå¼€ç›˜ä»·å’Œæ”¶ç›˜ä»·
  // è¯¥çº¿æ®µæœ‰è¾ƒå¤§çš„æè¾¹å®½åº¦ï¼ˆçœ‹èµ·æ¥åƒæ˜¯æŸ±çŠ¶å›¾çš„æ¡å¸¦ï¼‰ï¼Œè€Œä¸”ä¼šè¿›è¡Œç€è‰²ï¼ˆå¦‚æœæ”¶ç›˜ä»·å¤§äºå¼€ç›˜ä»·æ˜¯ç»¿è‰²ï¼Œå¦åˆ™ä¸ºçº¢è‰²ï¼‰
  g.append("line")
    // åªè®¾ç½®çº¿æ®µçš„èµ·å§‹ç‚¹å’Œç»ˆæ­¢ç‚¹çš„çºµåæ ‡å€¼ï¼Œç”±äºæ˜¯å‚ç›´å‘ä¸‹çš„ç›´çº¿ï¼Œæ‰€ä»¥å¯ä»¥æ¨ªåæ ‡å€¼é‡‡ç”¨é»˜è®¤å€¼
    .attr("y1", d => y(d.Open)) // èµ·å§‹ç‚¹çš„çºµåæ ‡å€¼
    .attr("y2", d => y(d.Close)) // ç»ˆæ­¢ç‚¹çš„çºµåæ ‡å€¼
    // è®¾ç½®æè¾¹å®½åº¦
    // é€šè¿‡æ¨ªè½´çš„æ¯”ä¾‹å°ºçš„æ–¹æ³• x.bandwidth() è·å– band çš„å®½åº¦ï¼ˆä¸åŒ…å«é—´éš™ paddingï¼‰
    .attr("stroke-width", x.bandwidth())
    // è®¾ç½®æè¾¹çš„é¢œè‰²
    // åŸºäºå¼€ç›˜ä»· d.Open å’Œæ”¶ç›˜ä»· d.Close çš„å¤§å°å…³ç³»è®¾ç½®ä¸åŒçš„é¢œè‰²
    // d3.schemeSet1 æ˜¯ä¸€ä¸ª Categorical Color Scheme åˆ†ç±»å‹çš„é…è‰²æ–¹æ¡ˆ
    // é¢„é€‰äº† 9 ç§è‰²å½©ç”¨äºæ ‡è¯†ä¸åŒçš„ç±»åˆ«
    // å…·ä½“å¯å‚è€ƒ d3-scale-chromatic æ¨¡å—çš„å®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-scale-chromatic/categorical#schemeSet1
    // å½“å¼€ç›˜ä»·å¤§äºæ”¶ç›˜ä»· d.Open > d.Close åˆ™é‡‡ç”¨é…è‰²æ–¹æ¡ˆï¼ˆæ•°ç»„ï¼‰çš„ç¬¬ä¸€ä¸ªå…ƒç´  d3.schemeSet1[0] å³çº¢è‰² #e41a1c
    // å½“æ”¶ç›˜ä»·å¤§äºå¼€ç›˜ä»· d.Close > d.Open åˆ™é‡‡ç”¨é…è‰²æ–¹æ¡ˆï¼ˆæ•°ç»„ï¼‰çš„ç¬¬ä¸‰ä¸ªå…ƒç´  d3.schemeSet1[2] å³ç»¿è‰² #4daf4a
    // å½“å¼€ç›˜ä»·ç­‰äºæ”¶ç›˜ä»·ï¼Œåˆ™é‡‡ç”¨é…è‰²æ–¹æ¡ˆï¼ˆæ•°ç»„ï¼‰çš„æœ€åä¸€ä¸ªå…ƒç´  d3.schemeSet1[8] å³ç°è‰² #999999
    .attr("stroke", d => d.Open > d.Close ? d3.schemeSet1[0]
      : d.Close > d.Open ? d3.schemeSet1[2]
        : d3.schemeSet1[8]);

  /**
   *
   * ä¸ºå›¾è¡¨æ·»åŠ æ³¨é‡Šä¿¡æ¯
   *
   */
  // ä½¿ç”¨äº† d3.utcFormat() åˆ›å»ºä¸€ä¸ªæ—¶é—´æ ¼å¼å™¨ï¼Œç”¨äºå°†æ—¥æœŸå¯¹è±¡è½¬å˜ä¸ºç‰¹å®šæ ¼å¼çš„å­—ç¬¦ä¸²
  // è¿™é‡Œæ ¼å¼å™¨çš„ä½œç”¨æ˜¯å°†æ—¥æœŸå¯¹è±¡è½¬æ¢ä¸ºã€Œæœˆä»½ æ—¥æœŸï¼Œå¹´ä»½ã€æ ¼å¼çš„å­—ç¬¦ä¸²
  const formatDate = d3.utcFormat("%B %-d, %Y");
  // ä½¿ç”¨äº† d3.format() åˆ›å»ºä¸€ä¸ªæ•°å€¼æ ¼å¼å™¨ï¼Œå¯¹æ•°å­—è¿›è¡Œä¿®çº¦ç­‰å¤„ç†ï¼Œç”Ÿæˆæ›´æ˜“äºé˜…è¯»çš„æ•°å€¼
  // è¿™é‡Œçš„æ ¼å¼å™¨çš„ä½œç”¨æ˜¯å°†æ•°å­—ä¿ç•™ 2 ä½å°æ•°
  const formatValue = d3.format(".2f");
  // è¯¥å‡½æ•°çš„ä½œç”¨æ˜¯å¯¹ä¼ å…¥çš„ä¸¤ä¸ªæ•°æ®è¿›è¡Œè½¬æ¢ï¼ˆåœ¨å…¶ä¸­ä¼šä½¿ç”¨æ ¼å¼å™¨è¿›è¡Œæ•°å€¼å¤„ç†ï¼‰
  // æœ€å¤–å±‚æ˜¯ä¸€ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œå®ƒæ¥å—çš„å‚æ•°æ˜¯ä¸€ä¸ªæ•°å€¼æ ¼å¼å™¨ d3.format("+.2%")
  // è¿™ä¸ªæ ¼å¼å™¨çš„ä½œç”¨æ˜¯å°†æ•°å­—è½¬æ¢ä½ç™¾åˆ†æ¯”ï¼Œå¹¶ä¿ç•™ 2 ä½å°æ•°ï¼Œè€Œä¸”ä¼šæ ¹æ®æ­£è´Ÿæ€§ï¼Œåœ¨æ•°å€¼å‰é¢æ·»åŠ æ­£è´Ÿå·
  // ç«‹å³æ‰§è¡Œå‡½æ•°è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•° y0 å’Œ y1
  // æ ¹æ®åé¢ ğŸ‘‡ è°ƒç”¨çš„æƒ…å†µï¼Œä¼ å…¥çš„ä¸¤ä¸ªå€¼æ˜¯å¼€ç›˜ä»· d.Open å’Œæ”¶ç›˜ä»· d.Closeï¼Œè¯¥å‡½æ•°ä¼šå¯¹å®ƒä»¬è¿›è¡Œè½¬æ¢
  // æ±‚å‡ºä¸¤è€…ä¹‹å·®ç›¸å¯¹äºå¼€ç›˜ä»·çš„å€¼ (y1 - y0) / y0ï¼Œå¹¶ç”¨æ•°å€¼æ ¼å¼å™¨å¯¹è®¡ç®—ç»“æœè¿›è¡Œå¤„ç†
  const formatChange = ((f) => (y0, y1) => f((y1 - y0) / y0))(d3.format("+.2%"));

  // ä»¥ tooltip çš„æ–¹å¼å±•ç¤ºæ³¨é‡Šä¿¡æ¯ï¼Œå³é¼ æ ‡ hover åˆ°ç‰¹å®šçš„åŒºåŸŸæ—¶æ‰æ˜¾ç¤ºä¸€ä¸ªå¸¦æœ‰æ³¨é‡Šä¿¡æ¯çš„æµ®çª—
  g.append("title")
    // è®¾ç½®æ–‡æœ¬å†…å®¹
    .text(d => `${formatDate(d.Date)}
    Open: ${formatValue(d.Open)}
    Close: ${formatValue(d.Close)} (${formatChange(d.Open, d.Close)})
    Low: ${formatValue(d.Low)}
    High: ${formatValue(d.High)}`);

});
