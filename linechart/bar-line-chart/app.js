// å‚è€ƒè‡ª https://observablehq.com/@d3/bar-line-chart

/**
 *
 * æ„å»º svg
 *
 */
const container = document.getElementById("container"); // å›¾åƒçš„å®¹å™¨

// è·å–å°ºå¯¸å¤§å°
const width = container.clientWidth; // å®½åº¦
const height = container.clientHeight; // é«˜åº¦
// margin å¯¹è±¡çš„ä½œç”¨æ˜¯åœ¨ svg çš„å¤–å‘¨è®¾ç½®ç•™ç™½ï¼Œæ„å»ºä¸€ä¸ªæ˜¾ç¤ºçš„å®‰å…¨åŒºï¼Œä»¥ä¾¿åœ¨å››å‘¨æ˜¾ç¤ºåæ ‡è½´
const margin = { top: 20, right: 30, bottom: 30, left: 40 };

// åˆ›å»º svg
// åœ¨å®¹å™¨ <div id="container"> å…ƒç´ å†…åˆ›å»ºä¸€ä¸ª SVG å…ƒç´ 
// è¿”å›ä¸€ä¸ªé€‰æ‹©é›†ï¼Œåªæœ‰ svg ä¸€ä¸ªå…ƒç´ 
const svg = d3
  .select("#container")
  .append("svg")
  .attr("width", width)
  .attr("height", height)
  .attr("viewBox", [0, 0, width, height]);

/**
 *
 * å¼‚æ­¥è·å–æ•°æ®
 * å†åœ¨å›è°ƒå‡½æ•°ä¸­æ‰§è¡Œç»˜åˆ¶æ“ä½œ
 *
 */
// æ•°æ®æ¥æºç½‘é¡µ https://observablehq.com/@d3/bar-line-chart çš„æ–‡ä»¶é™„ä»¶
const dataURL =
  "https://gist.githubusercontent.com/Benbinbin/adc5f7e08b5a25822d94491410b00a84/raw/231d0ecf6c266289da0969f5a890f6353744980f/new-passenger-cars.csv";

d3.csv(dataURL, d3.autoType).then((data) => {
  // éœ€è¦æ£€æŸ¥ä¸€ä¸‹æ•°æ®è§£æçš„ç»“æœï¼Œå¯èƒ½å¹¶ä¸æ­£ç¡®ï¼Œéœ€è¦åœ¨åé¢çš„æ­¥éª¤é‡Œå†è¿›è¡Œç›¸åº”çš„å¤„ç†
  console.log(data);

  /**
   *
   * æ„å»ºæ¯”ä¾‹å°º
   *
   */
  // è®¾ç½®æ¨ªåæ ‡è½´çš„æ¯”ä¾‹å°º
  // æ¨ªåæ ‡è½´çš„æ•°æ®æ˜¯ä¸åŒçš„å¹´ä»½ï¼ˆç±»åˆ«ï¼‰ï¼Œä½¿ç”¨ d3.scaleBand æ„å»ºä¸€ä¸ªå¸¦çŠ¶æ¯”ä¾‹å°º
  // ä½¿ç”¨ d3-scale æ¨¡å—
  // å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-scale/band æˆ– https://github.com/d3/d3-scale#scaleBand
  // æˆ–è¿™ä¸€ç¯‡ç¬”è®° https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-scale#å¸¦çŠ¶æ¯”ä¾‹å°º-band-scales
  const x = d3.scaleBand()
    // è®¾ç½®å®šä¹‰åŸŸèŒƒå›´ï¼ˆå¹´ä»½ï¼‰
    .domain(data.map(d => d.year))
    // è®¾ç½®å€¼åŸŸèŒƒå›´ï¼ˆæ‰€æ˜ å°„çš„å¯è§†å…ƒç´ ï¼‰
    // svg å…ƒç´ çš„å®½åº¦ï¼ˆå‡å»ç•™ç™½åŒºåŸŸï¼‰
    .rangeRound([margin.left, width - margin.right])
    .padding(0.1) // å¹¶è®¾ç½®é—´éš”å æ®ï¼ˆæŸ±å­ï¼‰åŒºé—´çš„æ¯”ä¾‹

  // è®¾ç½®å·¦ä¾§çºµåæ ‡è½´çš„æ¯”ä¾‹å°º
  // å·¦ä¾§çºµåæ ‡è½´çš„æ•°æ®æ˜¯è¿ç»­å‹çš„æ•°å€¼ï¼ˆè½½å®¢è½¦çš„é”€é‡ï¼‰ï¼Œä½¿ç”¨ d3.scaleLinear æ„å»ºä¸€ä¸ªçº¿æ€§æ¯”ä¾‹å°º
  // å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-scale/linear æˆ– https://github.com/d3/d3-scale/tree/main#linear-scales
  // æˆ–è¿™ä¸€ç¯‡ç¬”è®° https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-scale#çº¿æ€§æ¯”ä¾‹å°º-linear-scales
  const y1 = d3.scaleLinear()
    // è®¾ç½®å®šä¹‰åŸŸèŒƒå›´
    // [0, ymax] å…¶ä¸­ ymax æ˜¯å„å¹´ä»½è½½å®¢è½¦çš„é”€é‡ä¸­çš„æœ€å¤§å€¼
    .domain([0, d3.max(data, d => d.sales)])
    // è®¾ç½®å€¼åŸŸèŒƒå›´
    // svg å…ƒç´ çš„é«˜åº¦ï¼ˆå‡å»ç•™ç™½åŒºåŸŸï¼‰
    // ä½¿ç”¨ continue.rangeRound() æ–¹æ³•ï¼Œå¯ä»¥è¿›è¡Œä¿®çº¦ï¼Œä»¥ä¾¿å®ç°æ•´æ•°ï¼ˆæ±½è½¦çš„é”€é‡ï¼‰æ˜ å°„åˆ°æ•´æ•°ï¼ˆåƒç´ ï¼‰
    // âš ï¸ åº”è¯¥ç‰¹åˆ«ç•™æ„çºµåæ ‡è½´çš„å€¼åŸŸï¼ˆå¯è§†åŒ–å±æ€§ï¼Œè¿™é‡Œæ˜¯é•¿åº¦ï¼‰èŒƒå›´ [bottom, top]
    // ç”±äº svg çš„åæ ‡ä½“ç³»ä¸­å‘ä¸‹å’Œå‘å³æ˜¯æ­£æ–¹å‘ï¼Œå’Œæˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„ä¸ä¸€è‡´
    // æ‰€ä»¥è¿™é‡Œçš„å€¼åŸŸèŒƒå›´éœ€è¦é‡‡ç”¨ä»ä¸‹å¾€ä¸Šä¸å®šä¹‰åŸŸè¿›è¡Œæ˜ å°„
    .rangeRound([height - margin.bottom, margin.top])

  // è®¾ç½®å³ä¾§çºµåæ ‡è½´çš„æ¯”ä¾‹å°º
  // å³ä¾§çºµåæ ‡è½´çš„æ•°æ®æ˜¯è¿ç»­å‹çš„æ•°å€¼ï¼ˆç‡ƒæ²¹æ•ˆç‡ï¼‰ï¼Œä½¿ç”¨ d3.scaleLinear æ„å»ºä¸€ä¸ªçº¿æ€§æ¯”ä¾‹å°º
  const y2 = d3.scaleLinear()
    // è®¾ç½®å®šä¹‰åŸŸèŒƒå›´
    // [ymin, ymax] ä½¿ç”¨ d3.extent() è®¡ç®—å‡ºæ•°æ®é›†ä¸­ç‡ƒæ²¹æ•ˆç‡çš„èŒƒå›´
    .domain(d3.extent(data, d => d.efficiency))
    // è®¾ç½®å€¼åŸŸèŒƒå›´
    .rangeRound([height - margin.bottom, margin.top])

  /**
   *
   * ç»˜åˆ¶åæ ‡è½´
   *
   */
  // ç»˜åˆ¶æ¨ªåæ ‡è½´
  svg.append("g")
    // é€šè¿‡è®¾ç½® CSS çš„ transform å±æ€§å°†æ¨ªåæ ‡è½´å®¹å™¨ã€Œç§»åŠ¨ã€åˆ°åº•éƒ¨
    .attr("transform", `translate(0,${height - margin.bottom})`)
    // æ¨ªè½´æ˜¯ä¸€ä¸ªåˆ»åº¦å€¼æœä¸‹çš„åæ ‡è½´
    .call(d3.axisBottom(x)
      // è‡ªå®šä¹‰åæ ‡è½´çš„åˆ»åº¦å€¼
      // é€šè¿‡ axis.tickValues([values]) ä¼ é€’ä¸€ä¸ªæ•°ç»„ï¼Œç”¨å…¶ä¸­çš„å…ƒç´ è¦†ç›–æ¯”ä¾‹å°ºè‡ªåŠ¨ç”Ÿæˆçš„åˆ»åº¦å€¼
      // æ–¹æ³• d3.ticks(start, stop, count)
      // æ ¹æ® count æ•°é‡å¯¹ç‰¹å®šèŒƒå›´ï¼ˆç”± start å’Œ stop æŒ‡å®šï¼‰è¿›è¡Œå‡åˆ†ï¼Œè¿”å›ä¸€ä¸ªåŒ…å«ä¸€ç³»åˆ—åˆ†éš”å€¼çš„æ•°ç»„ï¼Œç”¨ä½œåˆ»åº¦å€¼
      // ç¬¬ä¸€ã€äºŒä¸ªå‚æ•° start å’Œ stop åˆ†åˆ«æŒ‡å®šèŒƒå›´çš„èµ·å§‹å’Œç»“æŸå€¼
      // è¿™é‡Œå…ˆé€šè¿‡ d3.extent(x.domain()) è·å–æ¨ªåæ ‡è½´æ¯”ä¾‹å°ºçš„å®šä¹‰åŸŸèŒƒå›´
      // è¿”å›å€¼æ˜¯ä¸€ä¸ªæ•°ç»„ [xmin, xmax]ï¼Œå†é€šè¿‡è§£æ„æ¥è·å– start å’Œ stop
      // ç¬¬ä¸‰ä¸ªå‚æ•° count ä½œä¸ºåˆ†å‰²æ•°é‡çš„å‚è€ƒå€¼ï¼Œé¿å…è¿‡å¤šçš„åˆ»åº¦å€¼å‡ºç°ï¼Œç›¸äº’é‡å å½±å“é˜…è¯»
      // å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-array/ticks#ticks æˆ– https://github.com/d3/d3-array/tree/main#ticks
      // æˆ–è¿™ä¸€ç¯‡ç¬”è®° https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-data-process#åˆ»åº¦ç”Ÿæˆ
      // å¯¹äºæ–¹æ³• d3.ticks(start, stop, count) æ‰€è¿”å›çš„æ•°ç»„ï¼Œå†é€šè¿‡ arr.filter() å¯¹é‡Œé¢çš„å…ƒç´ è¿›è¡Œç­›é€‰
      // é€šè¿‡æ¨ªåæ ‡è½´çš„æ¯”ä¾‹å°ºéªŒè¯ x(v) ä»…ç•™ä¸‹åœ¨æ•°æ®é›†ä¸­æœ‰å¯¹åº”æ•°æ®çš„å¹´ä»½
      .tickValues(d3.ticks(...d3.extent(x.domain()), width / 40).filter(v => x(v) !== undefined))
      // è€Œä¸”å°†åæ ‡è½´çš„å¤–ä¾§åˆ»åº¦ tickSizeOuter é•¿åº¦è®¾ç½®ä¸º 0ï¼ˆå³å–æ¶ˆåæ ‡è½´é¦–å°¾ä¸¤ç«¯çš„åˆ»åº¦ï¼‰
      .tickSizeOuter(0))
  // ğŸ’¡ æ³¨æ„ä»¥ä¸Šé€šè¿‡æ–¹æ³• selection.call(axis) çš„æ–¹å¼æ¥è°ƒç”¨åæ ‡è½´å¯¹è±¡ï¼ˆæ–¹æ³•ï¼‰
  // ä¼šå°†é€‰æ‹©é›†ï¼ˆåªåŒ…å«ä¸€ä¸ªå…ƒç´  <g>ï¼‰ä¼ é€’ç»™åæ ‡è½´å¯¹è±¡çš„æ–¹æ³•ï¼Œä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°
  // ä»¥ä¾¿å°†åæ ‡è½´åœ¨ç›¸åº”å®¹å™¨å†…éƒ¨æ¸²æŸ“å‡ºæ¥
  // å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-selection/control-flow#selection_call æˆ– https://github.com/d3/d3-selection#selection_call
  // æˆ–è¿™ä¸€ç¯‡æ–‡æ¡£ https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-data-binding#å…¶ä»–æ–¹æ³•

  // ç»˜åˆ¶å·¦ä¾§çºµåæ ‡è½´ï¼ˆè½½å®¢è½¦çš„é”€é‡ï¼‰
  svg.append("g")
    // é€šè¿‡è®¾ç½® CSS çš„ transform å±æ€§å°†çºµå‘åæ ‡è½´å®¹å™¨ã€Œç§»åŠ¨ã€åˆ°å·¦ä¾§
    .attr("transform", `translate(${margin.left},0)`)
    .style("color", "steelblue") // è®¾ç½®åæ ‡è½´çš„é¢œè‰²
    // å·¦ä¾§çš„çºµè½´æ˜¯ä¸€ä¸ªåˆ»åº¦å€¼æœå·¦çš„åæ ‡è½´
    // å¹¶ä½¿ç”¨åæ ‡è½´å¯¹è±¡çš„æ–¹æ³• axis.ticks() è®¾ç½®åæ ‡è½´çš„åˆ»åº¦æ•°é‡å’Œåˆ»åº¦å€¼æ ¼å¼
    // å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-axis#axis_ticks æˆ– https://github.com/d3/d3-axis/blob/v3.0.0/README.md#axis_ticks
    // å…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°ç”¨äºè®¾ç½®åˆ»åº¦æ•°é‡ï¼Œè¿™é‡Œè®¾ç½®ä¸º `null` è¡¨ç¤ºé‡‡ç”¨é»˜è®¤çš„åˆ»åº¦ç”Ÿæˆå™¨
    // è€Œç¬¬äºŒä¸ªå‚æ•°ç”¨äºè®¾ç½®åˆ»åº¦å€¼æ ¼å¼ï¼Œè¿™é‡Œè®¾ç½®ä¸º "s" è¡¨ç¤ºæ•°å€¼é‡‡ç”¨ SI-prefix å›½é™…å•ä½åˆ¶è¯å¤´ï¼Œä¾‹å¦‚ k è¡¨ç¤ºåƒï¼ŒM è¡¨ç¤ºç™¾ä¸‡
    // å…·ä½“å‚è€ƒ https://en.wikipedia.org/wiki/Metric_prefix
    // å…³äº D3 æ‰€æä¾›çš„æ•°å€¼æ ¼å¼å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://github.com/d3/d3-format
    .call(d3.axisLeft(y1).ticks(null, "s"))
    // åˆ æ‰ä¸Šä¸€æ­¥æ‰€ç”Ÿæˆçš„åæ ‡è½´çš„è½´çº¿ï¼ˆå®ƒå«æœ‰ domain ç±»åï¼‰
    .call(g => g.select(".domain").remove())
    // ä¸ºåæ ‡è½´æ·»åŠ é¢å¤–ä¿¡æ¯åç§°ï¼ˆä¸€èˆ¬æ˜¯åˆ»åº¦å€¼çš„å•ä½ç­‰ä¿¡æ¯ï¼‰
    .call(g => g.append("text")
      // å°†è¯¥æ–‡æœ¬ç§»åŠ¨åˆ°åæ ‡è½´çš„é¡¶éƒ¨ï¼ˆå³å®¹å™¨çš„å·¦ä¸Šè§’ï¼‰
      .attr("x", -margin.left)
      .attr("y", 10)
      .attr("fill", "currentColor") // è®¾ç½®æ–‡æœ¬çš„é¢œè‰²
      .attr("text-anchor", "start") // è®¾ç½®æ–‡æœ¬çš„å¯¹é½æ–¹å¼
      .text(data.y1)) // è®¾ç½®æ–‡æœ¬å†…å®¹

  // ç»˜åˆ¶å³ä¾§çºµåæ ‡è½´ï¼ˆè½½å®¢è½¦çš„æ²¹è€—ï¼‰
  svg.append("g")
    // é€šè¿‡è®¾ç½® CSS çš„ transform å±æ€§å°†çºµå‘åæ ‡è½´å®¹å™¨ã€Œç§»åŠ¨ã€åˆ°å³ä¾§
    .attr("transform", `translate(${width - margin.right},0)`)
    // å³ä¾§çš„çºµè½´æ˜¯ä¸€ä¸ªåˆ»åº¦å€¼æœå³çš„åæ ‡è½´
    .call(d3.axisRight(y2))
    // åˆ æ‰ä¸Šä¸€æ­¥æ‰€ç”Ÿæˆçš„åæ ‡è½´çš„è½´çº¿ï¼ˆå®ƒå«æœ‰ domain ç±»åï¼‰
    .call(g => g.select(".domain").remove())
    // ä¸ºåæ ‡è½´æ·»åŠ é¢å¤–ä¿¡æ¯åç§°ï¼ˆä¸€èˆ¬æ˜¯åˆ»åº¦å€¼çš„å•ä½ç­‰ä¿¡æ¯ï¼‰
    .call(g => g.append("text")
      .attr("x", margin.right)
      .attr("y", 10)
      .attr("fill", "currentColor")
      .attr("text-anchor", "end")
      .text(data.y2))

  /**
   *
   * ç»˜åˆ¶å›¾è¡¨å†…å®¹
   * åŒ…æ‹¬æ¡å½¢å›¾å’ŒæŠ˜çº¿å›¾
   *
   */
  // ç»˜åˆ¶æ¡å½¢å›¾å†…çš„æŸ±å­
  svg.append("g")
    .attr("fill", "steelblue") // è®¾ç½®æŸ±å­çš„é¢œè‰²
    .attr("fill-opacity", 0.8) // è®¾ç½®æŸ±å­çš„é€æ˜åº¦
    .selectAll("rect") // ä½¿ç”¨ <rect> å…ƒç´ æ¥ç»˜åˆ¶æŸ±å­
    .data(data) // ç»‘å®šçš„æ•°æ®
    .join("rect") // å°†å…ƒç´ ç»˜åˆ¶åˆ°é¡µé¢ä¸Š
    // ä¸ºæ¯ä¸ªçŸ©å½¢åˆ†åˆ«è®¾ç½®å·¦ä¸Šè§’ (x, y) åŠå…¶ width å’Œ height æ¥ç¡®å®šå…¶å®šä½å’Œå½¢çŠ¶
    // æ¯ä¸ªçŸ©å½¢çš„å·¦ä¸Šè§’æ¨ªè½´å®šä½ x ç”±å®ƒæ‰€ç»‘å®šçš„æ•°æ®ç‚¹çš„å¹´ä»½ d.year å†³å®š
    // ä½¿ç”¨æ¨ªåæ ‡è½´çš„æ¯”ä¾‹å°ºï¼ˆå¸¦çŠ¶æ¯”ä¾‹å°ºï¼‰x(d.year) è¿›è¡Œæ˜ å°„ï¼Œæ±‚å‡ºå…·ä½“çš„æ¨ªè½´åæ ‡å€¼
    .attr("x", d => x(d.year))
    // æ¯ä¸ªçŸ©å½¢çš„å®½åº¦
    // é€šè¿‡æ¨ªè½´çš„æ¯”ä¾‹å°ºçš„æ–¹æ³• x.bandwidth() è·å– band çš„å®½åº¦ï¼ˆä¸åŒ…å«é—´éš™ paddingï¼‰
    .attr("width", x.bandwidth())
    // æ¯ä¸ªçŸ©å½¢çš„å·¦ä¸Šè§’çºµè½´å®šä½ y ç”±å®ƒæ‰€ç»‘å®šçš„æ•°æ®ç‚¹çš„é”€é‡ d.sales å†³å®š
    // ä½¿ç”¨å·¦ä¾§çºµåæ ‡è½´çš„æ¯”ä¾‹å°ºï¼ˆçº¿æ€§æ¯”ä¾‹å°ºï¼‰y1(d.sales) è¿›è¡Œæ˜ å°„ï¼Œæ±‚å‡ºå…·ä½“çš„çºµè½´åæ ‡å€¼
    .attr("y", d => y1(d.sales))
    // æ¯ä¸ªçŸ©å½¢çš„é«˜åº¦
    // ç”±æ‰€ç»‘å®šçš„æ•°æ®ç‚¹çš„é”€é‡å†³å®š d.sales ä¸å·¦ä¾§çºµè½´çš„é›¶ç‚¹ä¹‹é—´çš„å·®å€¼æ‰€å†³å®š
    // âš ï¸ æ³¨æ„è¿™é‡Œçš„å·®å€¼æ˜¯ y1(0) - y1(d.sales) å› ä¸º svg çš„åæ ‡ä½“ç³»ä¸­å‘ä¸‹æ˜¯æ­£æ–¹å‘
    // æ‰€ä»¥é›¶ç‚¹å¯¹åº”çš„å·¦ä¾§çºµåæ ‡å€¼ y1(0) ä¼šæ›´å¤§ï¼Œå‡å» y1(d.sales) çš„å€¼æ±‚å‡ºçš„å·®å€¼æ‰æ˜¯é«˜åº¦
    .attr("height", d => y1(0) - y1(d.sales));

  // ä½¿ç”¨æ–¹æ³• d3.line() åˆ›å»ºä¸€ä¸ªçº¿æ®µç”Ÿæˆå™¨
  // çº¿æ®µç”Ÿæˆå™¨ä¼šåŸºäºç»™å®šçš„åæ ‡ç‚¹ç”Ÿæˆçº¿æ®µï¼ˆæˆ–æ›²çº¿ï¼‰
  // è°ƒç”¨çº¿æ®µç”Ÿæˆå™¨æ—¶è¿”å›çš„ç»“æœï¼Œä¼šåŸºäºç”Ÿæˆå™¨æ˜¯å¦è®¾ç½®äº†ç”»å¸ƒä¸Šä¸‹æ–‡ context è€Œä¸åŒã€‚å¦‚æœè®¾ç½®äº†ç”»å¸ƒä¸Šä¸‹æ–‡ contextï¼Œåˆ™ç”Ÿæˆä¸€ç³»åˆ—åœ¨ç”»å¸ƒä¸Šç»˜åˆ¶è·¯å¾„çš„æ–¹æ³•ï¼Œé€šè¿‡è°ƒç”¨å®ƒä»¬å¯ä»¥å°†è·¯å¾„ç»˜åˆ¶åˆ°ç”»å¸ƒä¸Šï¼›å¦‚æœæ²¡æœ‰è®¾ç½®ç”»å¸ƒä¸Šä¸‹æ–‡ contextï¼Œåˆ™ç”Ÿæˆå­—ç¬¦ä¸²ï¼Œå¯ä»¥ä½œä¸º `<path>` å…ƒç´ çš„å±æ€§ `d` çš„å€¼
  // å…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d3js.org/d3-shape/line æˆ– https://github.com/d3/d3-shape/tree/main#lines
  // æˆ–è¿™ä¸€ç¯‡ç¬”è®° https://datavis-note.benbinbin.com/article/d3/core-concept/d3-concept-shape#çº¿æ®µç”Ÿæˆå™¨-lines
  const line = d3.line()
    // è®¾ç½®æ¨ªåæ ‡è¯»å–å‡½æ•°
    // è¯¥å‡½æ•°ä¼šåœ¨è°ƒç”¨çº¿æ®µç”Ÿæˆå™¨æ—¶ï¼Œä¸ºæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œä»¥è¿”å›è¯¥æ•°æ®æ‰€å¯¹åº”çš„æ¨ªåæ ‡
    // è¿™é‡ŒåŸºäºæ¯ä¸ªæ•°æ®ç‚¹çš„å¹´ä»½ d.year å¹¶é‡‡ç”¨æ¯”ä¾‹å°º x è¿›è¡Œæ˜ å°„ï¼Œè®¡ç®—å‡ºç›¸åº”çš„æ¨ªåæ ‡
    // ğŸ’¡ å®é™…çš„æ¨ªåæ ‡å®½åº¦è¿˜è¦åŠ ä¸Šæ¡å¸¦çš„ä¸€åŠå®½åº¦ x.bandwidth() / 2
    // ğŸ’¡ è¿™æ˜¯ä¸ºäº†è®©æŠ˜çº¿å›¾çš„æ¯ä¸ªæ•°æ®ç‚¹ä¸æ¡å½¢å›¾çš„ç›¸åº”æ¡å¸¦çš„ï¼ˆå‚ç›´ï¼‰ä¸­å¿ƒå¯¹é½ï¼Œæ‰€ä»¥æ¨ªåæ ‡æ·»åŠ ä¸Šæ¡å¸¦çš„ä¸€åŠå®½åº¦
    .x(d => x(d.year) + x.bandwidth() / 2)
    // è®¾ç½®çºµåæ ‡è¯»å–å‡½æ•°
    .y(d => y2(d.efficiency))

  // ç»˜åˆ¶æŠ˜çº¿å›¾å†…çš„çº¿æ®µ
  svg.append("path") // ä½¿ç”¨è·¯å¾„ <path> å…ƒç´ ç»˜åˆ¶æŠ˜çº¿
    .attr("fill", "none") // åªéœ€è¦è·¯å¾„çš„æè¾¹ä½œä¸ºæŠ˜çº¿ï¼Œä¸éœ€è¦å¡«å……ï¼Œæ‰€ä»¥å±æ€§ fill è®¾ç½®ä¸º none
    .attr("stroke", "currentColor") // è®¾ç½®æè¾¹é¢œè‰²
    // stroke-miterlimit å±æ€§çº¦æŸä¸¤æ®µæŠ˜çº¿ç›¸äº¤æ—¶æ¥å¤´çš„å°–ç«¯é•¿åº¦
    // å¦‚æœåœ¨ç»˜åˆ¶æŠ˜çº¿å›¾æ—¶æ•°æ®ç‚¹è¾ƒå¤šï¼Œå¯ä»¥å°†å…ƒç´  `<path>` çš„å±æ€§ `stroke-miterlimit` è®¾ç½®ä¸º `1`
    // ä»¥é¿å…æŠ˜çº¿ã€Œé”‹åˆ©ã€äº¤æ¥å¤„è¿‡æ¸¡å»¶ä¼¸ï¼Œå¯¼è‡´è¯¥ç‚¹çš„æ•°æ®åç§»
    .attr("stroke-miterlimit", 1)
    .attr("stroke-width", 3) // è®¾ç½®æè¾¹å®½åº¦
    // è°ƒç”¨çº¿æ®µç”Ÿæˆå™¨ line(data) è¿”å›çš„ç»“æœæ˜¯å­—ç¬¦ä¸²
    // è¯¥å€¼ä½œä¸º `<path>` å…ƒç´ çš„å±æ€§ `d` çš„å€¼
    .attr("d", line(data));

  /**
   *
   * ä¸ºå›¾è¡¨æ·»åŠ æ³¨é‡Šä¿¡æ¯
   *
   */
  // ä»¥ tooltip çš„æ–¹å¼å±•ç¤ºæ³¨é‡Šä¿¡æ¯ï¼Œå³é¼ æ ‡ hover åˆ°ç‰¹å®šçš„åŒºåŸŸæ—¶æ‰æ˜¾ç¤ºä¸€ä¸ªå¸¦æœ‰æ³¨é‡Šä¿¡æ¯çš„æµ®çª—
  svg.append("g")
    // è¿™é‡Œåœ¨åŸæ¥çš„å›¾è¡¨ï¼ˆæŠ˜çº¿å›¾å’Œæ¡å½¢å›¾ï¼‰ä¸Šé¢å†æ·»åŠ ä¸€å±‚ã€Œä¸å¯è§ã€çš„æ¡å½¢å›¾
    // æ‰€ä»¥è¿™é‡Œå°†å¡«å…… fill è®¾ç½®ä¸º none
    .attr("fill", "none")
    // âš ï¸ ç”±äºå±æ€§ fill è®¾ç½®ä¸º none çš„ SVG å…ƒç´ æ— æ³•æˆä¸ºé¼ æ ‡äº‹ä»¶çš„ç›®æ ‡
    // éœ€è¦å°† pointer-events è®¾ç½®ä¸º all è¿›è¡Œã€Œæ ¡æ­£ã€ï¼Œåˆ™è¯¥å…ƒç´ åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼ˆæ— è®ºå±æ€§ fill è®¾ç½®ä¸ºä»»ä½•å€¼ï¼‰éƒ½å¯ä»¥å“åº”æŒ‡é’ˆäº‹ä»¶
    .attr("pointer-events", "all")
    // ä»¥ä¸‹ä»£ç æ˜¯å†ç»˜åˆ¶ä¸€ä¸ªã€Œä¸å¯è§ã€çš„æ¡å½¢å›¾
    // å¤§éƒ¨åˆ†æ­¥éª¤éƒ½æ˜¯å’Œå‰é¢æ‰€ç»˜åˆ¶æ¡å½¢å›¾çš„æ­¥éª¤ä¸€è‡´
    .selectAll("rect")
    .data(data)
    .join("rect")
    .attr("x", d => x(d.year))
    .attr("width", x.bandwidth())
    // è¿™äº›çŸ©å½¢æ˜¯é“ºæ»¡è¦†ç›–æ•´ä¸ª svg ç”»å¸ƒåŒºåŸŸ
    // æ¯ä¸ªçŸ©å½¢çš„å·¦ä¸Šè§’çºµè½´å®šä½ y éƒ½æ˜¯ 0ï¼Œå³ä½äº svg çš„æœ€é¡¶ç«¯
    .attr("y", 0)
    //  æ¯ä¸ªçŸ©å½¢çš„é«˜åº¦éƒ½æ˜¯æ•´ä¸ª svg çš„é«˜åº¦
    .attr("height", height)
    // æœ€åä¸ºæ¯ä¸ªçŸ©å½¢ <rect> å…ƒç´ ä¹‹å†…æ·»åŠ  <title> å…ƒç´ 
    // ä»¥ä¾¿é¼ æ ‡ hover åœ¨ç›¸åº”çš„å°çŸ©å½¢ä¹‹ä¸Šæ—¶ï¼Œå¯ä»¥æ˜¾ç¤º tooltip æç¤ºä¿¡æ¯
    .append("title")
    // è®¾ç½® tooltip çš„æ–‡æœ¬å†…å®¹
    // å…¶ä¸­ {d.year æ˜¯æ‰€å±çš„å¹´ä»½
    // è€Œ d.sales.toLocaleString("en") æ˜¯æ±½è½¦é”€é‡ï¼Œå¹¶å°†æ•°å­—è½¬æ¢ä¸ºç‰¹å®šè¯­è¨€ç¯å¢ƒä¸‹çš„å­—ç¬¦ä¸²å½¢å¼
    // è€Œ d.efficiency.toLocaleString("en") å°±æ˜¯æ±½è½¦æ²¹è€—ï¼Œå¹¶å°†æ•°å­—è½¬æ¢ä¸ºç‰¹å®šè¯­è¨€ç¯å¢ƒä¸‹çš„å­—ç¬¦ä¸²å½¢å¼
    .text(d =>
    `${d.year}
    ${d.sales.toLocaleString("en")} new cars sold
    ${d.efficiency.toLocaleString("en")} mpg average fuel efficiency`);

});
